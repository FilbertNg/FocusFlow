<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow - Ultimate Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-sidebar: #1f2937;
            --bg-card: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --accent-primary: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e5e7eb;
            --border-hover: #d1d5db;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --modal-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-sidebar: #020617;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --accent-primary: #60a5fa;
            --accent-hover: #3b82f6;
            --border-color: #334155;
            --border-hover: #475569;
            --input-bg: #1e293b;
            --input-border: #475569;
            --button-bg: #3b82f6;
            --button-hover: #2563eb;
            --danger: #f87171;
            --success: #34d399;
            --warning: #fbbf24;
            --modal-bg: #1e293b;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        * {
            font-family: 'Inter', sans-serif;
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            background-color: rgba(59, 130, 246, 0.2);
            border: 2px dashed #3b82f6;
        }
        .flashcard {
            perspective: 1000px;
        }
        .flashcard-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard-inner.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            backface-visibility: hidden;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .input-error {
            border: 2px solid var(--danger) !important;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .toast {
            background: var(--success);
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
            pointer-events: auto;
            cursor: pointer;
        }
        
        .toast.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 0.875rem;
            opacity: 0.9;
        }
    </style>
</head>
<body class="min-h-screen flex transition-colors duration-200" style="background-color: var(--bg-primary);">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    <!-- Fixed Sidebar -->
    <aside class="fixed inset-y-0 left-0 w-64 text-white flex flex-col shadow-lg z-10" style="background-color: var(--bg-sidebar);">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">FocusFlow</h1>
                <p class="text-sm text-gray-400 mt-1">Student Dashboard</p>
            </div>
            <button onclick="toggleTheme()" id="themeToggle" class="text-2xl hover:scale-110 transition-transform" title="Toggle theme">
                üåô
            </button>
        </div>
        
        <nav class="flex-1 p-4">
            <button onclick="switchModule('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 bg-blue-600 text-white transition">
                <span class="text-xl">üè°</span>
                <span class="font-medium">Today's Syllabus</span>
            </button>
            <button onclick="switchModule('tasks')" id="nav-tasks" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">üìù</span>
                <span class="font-medium">Tasks</span>
            </button>
            <button onclick="switchModule('grades')" id="nav-grades" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">üßÆ</span>
                <span class="font-medium">Grades</span>
            </button>
            <button onclick="switchModule('flashcards')" id="nav-flashcards" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">üÉè</span>
                <span class="font-medium">Flashcards</span>
            </button>
            <button onclick="switchModule('productivity')" id="nav-productivity" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">‚è±Ô∏è</span>
                <span class="font-medium">Productivity</span>
            </button>
            <button onclick="switchModule('music')" id="nav-music" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">üéµ</span>
                <span class="font-medium">Music Player</span>
            </button>
            <button onclick="switchModule('profile')" id="nav-profile" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg mb-2 text-gray-300 hover:bg-gray-700 transition">
                <span class="text-xl">üìä</span>
                <span class="font-medium">Profile</span>
            </button>
        </nav>
        
        <div class="p-4 border-t border-gray-700 text-xs text-gray-400">
            <p>¬© 2025 FocusFlow</p>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 ml-64 p-8">
        <!-- MODULE 1: TODAY'S SYLLABUS -->
        <div id="module-dashboard" class="module-content">
            <!-- Motivator Section -->
            <div id="motivatorSection" class="mb-8 rounded-xl p-6 shadow-sm border" style="background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border-color: var(--border-color);">
                <div class="flex items-center gap-4">
                    <div class="text-5xl" id="motivatorIcon">üî•</div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold mb-1" style="color: var(--text-primary);" id="motivatorTitle">Start Your Journey</h3>
                        <p class="text-lg" style="color: var(--text-secondary);" id="motivatorMessage">Begin your first Pomodoro session to track your progress!</p>
                        <div class="mt-2" id="motivatorAchievement" style="display: none;">
                            <span class="text-sm font-semibold" style="color: var(--text-tertiary);">Latest Achievement: <span id="latestAchievementText"></span></span>
                        </div>
                    </div>
                    <button onclick="switchModule('profile')" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--accent-primary); color: white;">View Stats</button>
                </div>
            </div>
            <!-- Greeting Section -->
            <div class="mb-8">
                <h2 class="text-4xl md:text-5xl font-bold mb-2" style="color: var(--text-primary);">
                    <span id="greeting">Good evening</span>, 
                    <span id="userName" class="cursor-pointer transition" style="color: var(--accent-primary);" title="Click to edit">Student</span>!
                </h2>
                <p style="color: var(--text-secondary);" id="currentDate"></p>
            </div>

            <!-- Today's Syllabus Feed -->
            <div id="syllabusContent" class="space-y-4 max-w-4xl">
                <!-- Action cards will be rendered here -->
            </div>
        </div>

        <!-- MODULE 5: PRODUCTIVITY / POMODORO TIMER -->
        <div id="module-productivity" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Productivity Timer</h2>
                <button onclick="openPomodoroSettings()" class="px-4 py-2 rounded-lg transition font-medium" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    ‚öôÔ∏è Settings
                </button>
            </div>
            
            <div class="max-w-2xl mx-auto">
                <div class="rounded-xl shadow-sm border p-8" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <!-- Mode Selection -->
                    <div class="flex gap-3 mb-8 justify-center">
                        <button onclick="setTimerMode('work')" id="mode-work" class="px-6 py-3 rounded-lg font-medium transition bg-blue-600 text-white">
                            Work (25 min)
                        </button>
                        <button onclick="setTimerMode('short')" id="mode-short" class="px-6 py-3 rounded-lg font-medium transition bg-gray-200 text-gray-900 hover:bg-gray-300">
                            Short Break (5 min)
                        </button>
                        <button onclick="setTimerMode('long')" id="mode-long" class="px-6 py-3 rounded-lg font-medium transition bg-gray-200 text-gray-900 hover:bg-gray-300">
                            Long Break (15 min)
                        </button>
                    </div>
                    
                    <!-- Timer Display -->
                    <div class="text-center mb-8">
                        <div id="timerDisplay" class="text-7xl font-bold mb-4" style="color: var(--text-primary);">25:00</div>
                        <p id="currentModeLabel" class="text-xl" style="color: var(--text-secondary);">Work Session</p>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="flex gap-4 justify-center">
                        <button onclick="startTimer()" id="startBtn" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg transition font-medium text-lg">
                            Start
                        </button>
                        <button onclick="pauseTimer()" id="pauseBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-8 py-3 rounded-lg transition font-medium text-lg hidden">
                            Pause
                        </button>
                        <button onclick="resetTimer()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg transition font-medium text-lg">
                            Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODULE 6: MUSIC PLAYER -->
        <div id="module-music" class="module-content hidden">
            <h2 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">Music Player</h2>
            
            <div class="max-w-4xl">
                <!-- Empty State / Upload Section -->
                <div id="musicEmptyState" class="rounded-xl shadow-sm border p-12 text-center mb-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <div class="text-6xl mb-4">üé∂</div>
                    <h3 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">Upload Your Study Music</h3>
                    <p class="mb-6" style="color: var(--text-secondary);">Upload your favorite study music to get started</p>
                    <label for="musicFileInput" class="cursor-pointer inline-block px-6 py-3 rounded-lg font-medium transition" style="background-color: var(--accent-primary); color: white;">
                        üìÅ Choose Music Files
                    </label>
                    <input type="file" id="musicFileInput" accept="audio/*" multiple class="hidden" onchange="handleMusicUpload(event)">
                </div>
                
                <!-- Music Player (Hidden Initially) -->
                <div id="musicPlayerSection" class="hidden">
                    <!-- Player Controls -->
                    <div class="rounded-xl shadow-sm border p-6 mb-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="flex items-center gap-6">
                            <div class="text-5xl">üéµ</div>
                            <div class="flex-1">
                                <h3 class="font-semibold mb-1" style="color: var(--text-primary);" id="currentTrackName">No track playing</h3>
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-sm" style="color: var(--text-secondary);" id="currentTime">0:00</span>
                                    <input type="range" id="seekBar" min="0" max="100" value="0" class="flex-1" style="accent-color: var(--accent-primary);" oninput="seekTrack(this.value)">
                                    <span class="text-sm" style="color: var(--text-secondary);" id="totalDuration">0:00</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="previousTrack()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-secondary); color: var(--text-primary);">‚èÆÔ∏è</button>
                                    <button onclick="togglePlayPause()" id="playPauseBtn" class="px-6 py-2 rounded-lg font-medium transition" style="background-color: var(--accent-primary); color: white;">‚ñ∂Ô∏è Play</button>
                                    <button onclick="nextTrack()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-secondary); color: var(--text-primary);">‚è≠Ô∏è</button>
                                    <div class="flex items-center gap-2 ml-auto">
                                        <span style="color: var(--text-secondary);">üîä</span>
                                        <input type="range" id="volumeSlider" min="0" max="100" value="50" class="w-24" style="accent-color: var(--accent-primary);" oninput="updateVolume(this.value)">
                                        <span class="text-sm" style="color: var(--text-secondary);" id="volumeLabel">50%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Playlist -->
                    <div class="rounded-xl shadow-sm border p-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Playlist</h3>
                            <label for="musicFileInputAdd" class="cursor-pointer px-4 py-2 rounded-lg text-sm font-medium transition" style="background-color: var(--accent-primary); color: white;">
                                + Add More
                            </label>
                            <input type="file" id="musicFileInputAdd" accept="audio/*" multiple class="hidden" onchange="handleMusicUpload(event)">
                        </div>
                        <div id="playlistContainer" class="space-y-2">
                            <!-- Playlist items will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <!-- Hidden Audio Element -->
                <audio id="musicAudioPlayer" style="display: none;"></audio>
            </div>
        </div>

        <!-- MODULE 7: PROFILE & ANALYTICS -->
        <div id="module-profile" class="module-content hidden">
            <h2 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">Profile &amp; Analytics</h2>
            
            <div class="max-w-6xl">
                <!-- Profile Section -->
                <div class="rounded-xl shadow-sm border p-6 mb-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Study Goal</h3>
                    <div class="flex gap-4 items-center">
                        <label class="font-medium" style="color: var(--text-secondary);">Daily Study Goal (minutes):</label>
                        <input type="number" id="dailyGoalInput" min="1" max="1440" value="50" class="px-4 py-2 rounded-lg focus:outline-none focus:ring-2 w-24" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);" onblur="validateDailyGoalInput(this)">
                <div class="error-message" id="error-dailyGoalInput">Please enter a number between 1 and 1440</div>
                        <button onclick="saveDailyGoal()" class="px-4 py-2 rounded-lg transition font-medium" style="background-color: var(--button-bg); color: white;">Save</button>
                    </div>
                </div>

                <!-- Study Streak -->
                <div class="rounded-xl shadow-sm border p-6 mb-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Study Streak</h3>
                    <div id="streakDisplay" class="text-center py-6">
                        <div class="text-5xl mb-2">üî•</div>
                        <div class="text-3xl font-bold" style="color: var(--text-primary);" id="streakCount">0-Day Streak</div>
                        <p class="mt-2" style="color: var(--text-secondary);" id="streakMessage">Start studying to build your streak!</p>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="rounded-xl shadow-sm border p-6 mb-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Achievements</h3>
                    <div id="achievementsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <!-- Achievements will be rendered here -->
                    </div>
                </div>

                <!-- Analytics Chart -->
                <div class="rounded-xl shadow-sm border p-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold" style="color: var(--text-primary);">Study Analytics</h3>
                        <div class="flex gap-2">
                            <button onclick="setChartView('daily')" id="chartBtn-daily" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--button-bg); color: white;">Daily</button>
                            <button onclick="setChartView('weekly')" id="chartBtn-weekly" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Weekly</button>
                            <button onclick="setChartView('monthly')" id="chartBtn-monthly" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Monthly</button>
                        </div>
                    </div>
                    <div id="chartContainer" class="min-h-[400px]">
                        <!-- Chart will be rendered here -->
                    </div>
                </div>

                <!-- Profile Stats -->
                <div class="rounded-xl shadow-sm border p-6 mt-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Study Stats</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--bg-secondary);">
                            <div class="text-2xl font-bold" style="color: var(--accent-primary);" id="totalStudyTime">0</div>
                            <div class="text-sm mt-1" style="color: var(--text-secondary);">Total Minutes</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--bg-secondary);">
                            <div class="text-2xl font-bold" style="color: var(--success);" id="avgDailyTime">0</div>
                            <div class="text-sm mt-1" style="color: var(--text-secondary);">Avg Daily (30d)</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--bg-secondary);">
                            <div class="text-2xl font-bold" style="color: #a855f7;" id="totalSessions">0</div>
                            <div class="text-sm mt-1" style="color: var(--text-secondary);">Pomodoros</div>
                        </div>
                        <div class="text-center p-4 rounded-lg" style="background-color: var(--bg-secondary);">
                            <div class="text-2xl font-bold" style="color: var(--warning);" id="productiveDays">0</div>
                            <div class="text-sm mt-1" style="color: var(--text-secondary);">Productive Days</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODULE 2: TASK BOARD -->
        <div id="module-tasks" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Tasks</h2>
                <div class="flex gap-2">
                    <button onclick="setTasksView('kanban')" id="taskView-kanban" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--accent-primary); color: white;">
                        üìã Kanban
                    </button>
                    <button onclick="setTasksView('calendar')" id="taskView-calendar" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        üìÖ Calendar
                    </button>
                    <button onclick="setTasksView('list')" id="taskView-list" class="px-4 py-2 rounded-lg font-medium transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        üìù List
                    </button>
                </div>
            </div>
            
            <div id="tasksViewContainer">
                <!-- View content will be rendered here -->
            </div>
            
            <!-- Hidden Kanban Template -->
            <div id="kanbanTemplate" style="display: none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- To Do Column -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg text-gray-900">To Do <span class="text-gray-500 text-sm" id="todoCount">(0)</span></h3>
                        <button onclick="openAddTaskModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm transition">
                            + Add
                        </button>
                    </div>
                    <div id="todoColumn" class="kanban-column space-y-3 min-h-[300px]" data-column="todo"></div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg text-gray-900">In Progress <span class="text-gray-500 text-sm" id="inprogressCount">(0)</span></h3>
                    </div>
                    <div id="inprogressColumn" class="kanban-column space-y-3 min-h-[300px]" data-column="inprogress"></div>
                </div>

                <!-- Done Column -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg text-gray-900">Done <span class="text-gray-500 text-sm" id="doneCount">(0)</span></h3>
                    </div>
                    <div id="doneColumn" class="kanban-column space-y-3 min-h-[300px]" data-column="done"></div>
                </div>
            </div>
            </div>
        </div>

        <!-- MODULE 3: GRADE TRACKER -->
        <div id="module-grades" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Grade Tracker</h2>
                <button onclick="openAddCourseModal()" class="px-4 py-2 rounded-lg transition font-medium" style="background-color: var(--button-bg); color: white;">
                    + Add Course
                </button>
            </div>
            
            <div id="coursesContainer" class="space-y-4">
                <!-- Courses will be rendered here -->
            </div>
        </div>

        <!-- MODULE 4: FLASHCARDS -->
        <div id="module-flashcards" class="module-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Flashcard Decks</h2>
                <button onclick="openAddDeckModal()" class="px-4 py-2 rounded-lg transition font-medium" style="background-color: var(--button-bg); color: white;">
                    + Add Deck
                </button>
            </div>
            
            <div id="decksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Decks will be rendered here -->
            </div>
        </div>

        <!-- Study Mode View -->
        <div id="studyModeContainer" class="hidden">
            <div class="mb-6">
                <button onclick="exitStudyMode()" class="text-blue-600 hover:text-blue-700 font-medium">
                    ‚Üê Back to Decks
                </button>
            </div>
            
            <div class="max-w-2xl mx-auto">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center" id="studyDeckName"></h3>
                
                <!-- Question Card -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 mb-4">
                    <p class="text-sm font-semibold text-gray-600 mb-2">Question:</p>
                    <p class="text-2xl text-gray-900 mb-6" id="cardQuestion"></p>
                    
                    <!-- Answer Input -->
                    <div class="mb-4">
                        <textarea 
                            id="userAnswer" 
                            placeholder="Type your answer here..."
                            rows="3"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 resize-none"
                        ></textarea>
                    </div>
                    
                    <!-- Check Answer Button -->
                    <div class="flex justify-center mb-4">
                        <button onclick="checkAnswer()" id="checkAnswerBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg transition font-medium text-lg">
                            Check Answer
                        </button>
                    </div>
                    
                    <!-- Answer Reveal Section -->
                    <div id="answerReveal" class="hidden">
                        <div class="border-t border-gray-200 pt-4 mt-4">
                            <p class="text-sm font-semibold text-gray-600 mb-2">Correct Answer:</p>
                            <p class="text-xl text-gray-900 mb-4" id="correctAnswer"></p>
                            
                            <!-- Feedback -->
                            <div id="feedbackMessage" class="p-4 rounded-lg text-center font-semibold text-lg">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <button onclick="previousCard()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-6 py-3 rounded-lg transition font-medium">
                        ‚Üê Previous
                    </button>
                    <p class="text-gray-600" id="cardProgress"></p>
                    <button onclick="nextCard()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-6 py-3 rounded-lg transition font-medium">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Mini-Timer -->
    <div id="miniTimer" class="fixed bottom-4 right-4 text-white rounded-full shadow-lg px-6 py-4 cursor-pointer transition hidden z-50" style="background-color: var(--bg-sidebar);" onclick="switchModule('productivity')">
        <div class="flex items-center gap-3">
            <span id="miniTimerIcon" class="text-2xl">‚è±Ô∏è</span>
            <div>
                <div id="miniTimerDisplay" class="text-lg font-bold">25:00</div>
                <div id="miniTimerMode" class="text-xs" style="color: var(--text-tertiary);">Work</div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add New Task</h3>
            <input 
                type="text" 
                id="newTaskInput" 
                placeholder="Task title..."
                class="w-full px-4 py-2 rounded-lg mb-3 focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);"
            />
            <div class="mb-3">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Description (optional)</label>
                <textarea 
                    id="newTaskDescription" 
                    placeholder="Task details..."
                    rows="3"
                    class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);"
                ></textarea>
            </div>
            <div class="mb-3">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Domain/Course (optional)</label>
                <input 
                    type="text" 
                    id="newTaskDomain" 
                    placeholder="e.g., Data Structure, Math 101..."
                    class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);"
                />
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Due Date (optional)</label>
                <input 
                    type="date" 
                    id="newTaskDueDate" 
                    class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);"
                />
            </div>
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddTaskModal()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button onclick="addTask()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--button-bg); color: white;">
                    Add Task
                </button>
            </div>
        </div>
    </div>

    <!-- Add Link Modal -->
    <div id="addLinkModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Quick Link</h3>
            <input 
                type="text" 
                id="newLinkName" 
                placeholder="Link name (e.g., Google Scholar)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <input 
                type="text" 
                id="newLinkUrl" 
                placeholder="URL (e.g., https://scholar.google.com)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <input 
                type="text" 
                id="newLinkIcon" 
                placeholder="Emoji icon (e.g., üìö)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddLinkModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addQuickLink()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Link
                </button>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl max-h-[90vh] overflow-y-auto" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Course</h3>
            <input 
                type="text" 
                id="newCourseName" 
                placeholder="Course name (e.g., MATH 101)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddCourseModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addCourse()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Course
                </button>
            </div>
        </div>
    </div>

    <!-- Add Key Date Modal -->
    <div id="addKeyDateModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Key Date</h3>
            <input 
                type="text" 
                id="newKeyDateLabel" 
                placeholder="Label (e.g., Midterm, Final)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <input 
                type="date" 
                id="newKeyDateDate" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddKeyDateModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addKeyDate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Key Date
                </button>
            </div>
        </div>
    </div>

    <!-- Add Assignment Modal -->
    <div id="addAssignmentModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Assignment</h3>
            <input 
                type="text" 
                id="newAssignmentName" 
                placeholder="Assignment name"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <input 
                type="number" 
                id="newAssignmentWeight" 
                placeholder="Weight (%)"
                min="0"
                max="100"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <input 
                type="number" 
                id="newAssignmentScore" 
                placeholder="Score (%)"
                min="0"
                max="100"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddAssignmentModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addAssignment()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Assignment
                </button>
            </div>
        </div>
    </div>

    <!-- Add Deck Modal -->
    <div id="addDeckModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Flashcard Deck</h3>
            <input 
                type="text" 
                id="newDeckName" 
                placeholder="Deck name (e.g., Biology - Chapter 4)"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900"
            />
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddDeckModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addDeck()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Deck
                </button>
            </div>
        </div>
    </div>

    <!-- Pomodoro Settings Modal -->
    <div id="pomodoroSettingsModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Timer Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Work Duration (minutes)</label>
                    <input type="number" id="settingsWork" min="1" max="120" value="25" class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);" onblur="validatePomodoroInput(this, 1, 120)">
                <div class="error-message" id="error-settingsWork">Please enter a number between 1 and 120</div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Short Break (minutes)</label>
                    <input type="number" id="settingsShortBreak" min="1" max="60" value="5" class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);" onblur="validatePomodoroInput(this, 1, 60)">
                <div class="error-message" id="error-settingsShortBreak">Please enter a number between 1 and 60</div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Long Break (minutes)</label>
                    <input type="number" id="settingsLongBreak" min="1" max="60" value="15" class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);" onblur="validatePomodoroInput(this, 1, 60)">
                <div class="error-message" id="error-settingsLongBreak">Please enter a number between 1 and 60</div>
                </div>
            </div>
            <div class="flex gap-2 justify-end mt-6">
                <button onclick="closePomodoroSettings()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button onclick="savePomodoroSettings()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--button-bg); color: white;">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Add Card Modal -->
    <div id="addCardModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <h3 class="text-xl font-semibold mb-4" style="color: var(--text-primary);">Add Flashcard</h3>
            <textarea 
                id="newCardFront" 
                placeholder="Front of card"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 resize-none"
            ></textarea>
            <textarea 
                id="newCardBack" 
                placeholder="Back of card"
                rows="3"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 resize-none"
            ></textarea>
            <div class="flex gap-2 justify-end">
                <button onclick="closeAddCardModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-900 px-4 py-2 rounded-lg transition">
                    Cancel
                </button>
                <button onclick="addCard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                    Add Card
                </button>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="taskModal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: var(--modal-overlay);">
        <div class="rounded-xl p-6 max-w-lg w-full mx-4 shadow-2xl" style="background-color: var(--modal-bg);">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold" style="color: var(--text-primary);" id="modalTaskTitle">Task Title</h3>
                <button onclick="closeTaskModal()" class="text-2xl" style="color: var(--text-secondary);">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Domain:</label>
                    <div id="modalTaskDomain"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Due Date:</label>
                    <div style="color: var(--text-primary);" id="modalTaskDueDate">No due date</div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Status:</label>
                    <div id="modalTaskStatus"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Change Status:</label>
                    <select id="modalTaskStatusSelect" class="w-full px-4 py-2 rounded-lg focus:outline-none focus:ring-2" style="background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-primary);">
                        <option value="todo">To Do</option>
                        <option value="inprogress">In Progress</option>
                        <option value="done">Done</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Description:</label>
                    <div class="p-3 rounded-lg max-h-40 overflow-y-auto" style="background-color: var(--bg-secondary); color: var(--text-primary);" id="modalTaskDescription">No description</div>
                </div>
            </div>
            
            <div class="flex gap-2 justify-end mt-6">
                <button onclick="deleteTaskFromModal()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--danger); color: white;">
                    Delete Task
                </button>
                <button onclick="updateTaskStatus()" class="px-4 py-2 rounded-lg transition" style="background-color: var(--button-bg); color: white;">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== DEFAULT STATE =====
        const DEFAULT_STATE = {
            // User Profile
            userName: 'Student',
            dailyFocus: '',
            focusIsSet: false,
            dailyStudyGoal: 50,
            theme: 'light',
            
            // Tasks (including all task views data)
            tasks: [],
            tasksViewMode: 'kanban',
            tasksListSort: { column: 'dueDate', 'direction': 'asc' },
            tasksCalendarMonth: { year: new Date().getFullYear(), month: new Date().getMonth() },
            
            // Grades
            courses: [],
            
            // Flashcards
            flashcardDecks: [],
            currentDeckId: null,
            studyMode: {
                active: false,
                deckId: null,
                currentCardIndex: 0,
                showingBack: false,
                answerChecked: false
            },
            
            // Pomodoro
            pomodoroSettings: {
                work: 25,
                shortBreak: 5,
                longBreak: 15
            },
            pomodoro: {
                mode: 'work',
                remainingSeconds: 1500,
                isRunning: false,
                startTime: null,
                timerInterval: null
            },
            studyHistory: [],
            
            // Quick Links
            quickLinks: [
                { id: 'link1', name: 'Google Scholar', url: 'https://scholar.google.com', icon: 'üìö' },
                { id: 'link2', name: 'GitHub', url: 'https://github.com', icon: 'üíª' },
                { id: 'link3', name: 'YouTube', url: 'https://youtube.com', icon: 'üé•' },
                { id: 'link4', name: 'Stack Overflow', url: 'https://stackoverflow.com', icon: '‚ùì' }
            ],
            
            // Achievements
            unlockedAchievements: [],
            
            // Music
            musicPlaylist: [], // <-- ADDED THIS
            
            // UI State
            currentModule: 'dashboard',
            currentCourseId: null,
            chartView: 'daily',
            
            // Timestamps
            lastSaved: Date.now()
        };

        // ===== STATE MANAGEMENT =====
        let appState = {
            tasksViewMode: 'kanban',
            tasksCalendarMonth: { year: new Date().getFullYear(), month: new Date().getMonth() },
            tasksListSort: { column: 'dueDate', direction: 'asc' },
            theme: 'light',
            currentModule: 'dashboard',
            userName: 'Student',
            dailyFocus: '',
            focusIsSet: false,
            quickLinks: [
                { id: 'link1', name: 'Google Scholar', url: 'https://scholar.google.com', icon: 'üìö' },
                { id: 'link2', name: 'GitHub', url: 'https://github.com', icon: 'üíª' },
                { id: 'link3', name: 'YouTube', url: 'https://youtube.com', icon: 'üé•' },
                { id: 'link4', name: 'Stack Overflow', url: 'https://stackoverflow.com', icon: '‚ùì' }
            ],
            tasks: [],
            courses: [],
            flashcardDecks: [],
            musicPlaylist: [], // <-- ADDED THIS
            currentCourseId: null,
            currentDeckId: null,
            studyMode: {
                active: false,
                deckId: null,
                currentCardIndex: 0,
                showingBack: false,
                answerChecked: false
            },
            pomodoro: {
                mode: 'work',
                remainingSeconds: 1500,
                isRunning: false,
                startTime: null,
                timerInterval: null
            },
            pomodoroSettings: {
                work: 25,
                shortBreak: 5,
                longBreak: 15
            },
            studyHistory: [],
            dailyStudyGoal: 50,
            ambientSound: {
                current: null,
                volume: 50,
                playing: false
            },
            chartView: 'daily',
            audioContext: null,
            currentAudioNode: null
        };

        // ===== STATE PERSISTENCE =====
        // In-memory fallback for sandboxed environments
        let memoryStorage = {};
        
        async function saveState(reason = '') {
            try {
                // Update lastSaved timestamp
                appState.lastSaved = Date.now();
                
                // Prepare state to save (exclude runtime properties)
                const stateToSave = {
                    userName: appState.userName,
                    dailyFocus: appState.dailyFocus,
                    focusIsSet: appState.focusIsSet,
                    dailyStudyGoal: appState.dailyStudyGoal,
                    theme: appState.theme,
                    tasks: appState.tasks,
                    tasksViewMode: appState.tasksViewMode,
                    tasksListSort: appState.tasksListSort,
                    tasksCalendarMonth: appState.tasksCalendarMonth,
                    courses: appState.courses,
                    flashcardDecks: appState.flashcardDecks,
                    pomodoroSettings: appState.pomodoroSettings,
                    studyHistory: appState.studyHistory,
                    quickLinks: appState.quickLinks,
                    musicPlaylist: appState.musicPlaylist, // <-- ADDED THIS
                    chartView: appState.chartView,
                    unlockedAchievements: getUnlockedAchievements(),
                    currentModule: appState.currentModule,
                    lastSaved: appState.lastSaved
                };
                
                // Save to FastAPI backend
                const response = await fetch('/api/save-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(stateToSave)
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                
                if (reason) {
                    console.log(`State saved to backend (${reason})`);
                }
                
            } catch (error) {
                console.error('Error saving state to backend:', error);
                // Optionally show a "failed to save" toast to the user
            }
        }

        // Debounced auto-save function
        let autoSaveTimeout;
        function autoSave(reason = 'autosave') {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                await saveState(reason);
            }, 500);
        }

        async function loadState() {
            try {
                // Load from FastAPI backend
                const response = await fetch('/api/load-data');
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                
                const parsedState = await response.json();
                
                // Merge with defaults (in case new fields were added)
                appState = {
                    ...DEFAULT_STATE,
                    ...parsedState,
                    // Deep merge nested objects
                    pomodoroSettings: {
                        ...DEFAULT_STATE.pomodoroSettings,
                        ...(parsedState.pomodoroSettings || {})
                    },
                    pomodoro: {
                        ...DEFAULT_STATE.pomodoro,
                        mode: parsedState.pomodoro?.mode || 'work',
                        remainingSeconds: parsedState.pomodoro?.remainingSeconds || 1500,
                        isRunning: false,
                        startTime: null,
                        timerInterval: null
                    },
                    studyMode: {
                        ...DEFAULT_STATE.studyMode,
                        ...(parsedState.studyMode || {}),
                        active: false
                    },
                    ambientSound: {
                        ...DEFAULT_STATE.ambientSound,
                        ...(parsedState.ambientSound || {})
                    },
                    tasksListSort: {
                        ...DEFAULT_STATE.tasksListSort,
                        ...(parsedState.tasksListSort || {})
                    },
                    tasksCalendarMonth: {
                        ...DEFAULT_STATE.tasksCalendarMonth,
                        ...(parsedState.tasksCalendarMonth || {})
                    }
                };
                
                // Update the runtime music playlist from the loaded state
                musicPlaylist = appState.musicPlaylist || [];
                
                if (parsedState.unlockedAchievements) {
                    saveUnlockedAchievements(parsedState.unlockedAchievements);
                }
                
                console.log('State loaded from backend');
                
            } catch (error) {
                console.error('Error loading state from backend:', error);
                appState = JSON.parse(JSON.stringify(DEFAULT_STATE));
                musicPlaylist = appState.musicPlaylist;
                console.log('Failed to load state, using defaults');
            }
        }
        
        // Helper function to render all modules after loading
        function renderAllModules() {
            try {
                renderQuickLinks();
                renderKanbanBoard();
                renderCourses();
                renderDecks();
                updateProfileStats();
                renderAchievements();
                renderChart();
                buildDailySyllabus();
                updateMotivator();
                console.log('All modules rendered');
            } catch (error) {
                console.error('Error rendering modules:', error);
            }
        }
        
        // Apply theme from state
        function applyThemeFromState() {
            applyTheme();
        }
        
        // Restore Pomodoro state if was running
        function restorePomodoroState() {
            initializePomodoro();
            updateTimerDisplay();
        }
        
        // Legacy function name compatibility
        function saveToLocalStorage() {
            saveState('legacy_call');
        }

        function loadFromLocalStorage() {
            loadState();
        }

        // ===== INDEXEDDB FOR MUSIC =====
        let musicDB;
        

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. Load all app state from the backend
                await loadState();
                
                // 2. Initialize app with loaded state
                initializeApp();
                
                // 3. Load music playlist from the loaded state
                if (musicPlaylist.length > 0) {
                    document.getElementById('musicEmptyState').classList.add('hidden');
                    document.getElementById('musicPlayerSection').classList.remove('hidden');
                    renderPlaylist();
                    // Optionally load the first track info without playing
                    const trackNameEl = document.getElementById('currentTrackName');
                    if (trackNameEl) trackNameEl.textContent = musicPlaylist[0].name;
                }
                
                // 4. Setup event listeners
                setupEventListeners();
                
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Error during app initialization:', error);
            }
        });

        function initializeApp() {
            // Run task migration first
            runTaskMigration();
            
            // Apply theme
            applyTheme();
            
            updateGreeting();
            updateDateTime();
            document.getElementById('userName').textContent = appState.userName;
            
            // Initialize focus widget
            // updateFocusWidget();
            
            renderQuickLinks();
            renderKanbanBoard();
            renderCourses();
            renderDecks();
            
            // Initialize timer with custom settings
            initializePomodoro();
            updateTimerDisplay();
            
            // Initialize music player (session-based, starts empty)
            
            // Initialize profile/analytics
            document.getElementById('dailyGoalInput').value = appState.dailyStudyGoal;
            updateProfileStats();
            renderAchievements();
            renderChart();
            
            // Build Today's Syllabus
            buildDailySyllabus();
            
            // Update motivator
            updateMotivator();
            
            setInterval(updateDateTime, 60000);
        }

        function setupEventListeners() {
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                userNameEl.addEventListener('click', function() {
                    const newName = prompt('Enter your name:', appState.userName);
                    if (newName && newName.trim()) {
                        appState.userName = newName.trim();
                        this.textContent = appState.userName;
                        saveState('profile_name_changed');
                    }
                });
            }

            const taskInput = document.getElementById('newTaskInput');
            if (taskInput) {
                taskInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') addTask();
                });
            }
            
            // ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }
        
        function closeAllModals() {
            const modals = [
                'addTaskModal', 'addLinkModal', 'addCourseModal', 'addKeyDateModal',
                'addAssignmentModal', 'addDeckModal', 'addCardModal', 'pomodoroSettingsModal', 'taskModal'
            ];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && modal.classList.contains('flex')) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            });
        }

        // ===== MODULE SWITCHING =====
        function switchModule(moduleName) {
            appState.currentModule = moduleName;
            
            // CRITICAL: Hide all sub-views/modes before switching
            const studyModeContainer = document.getElementById('studyModeContainer');
            if (studyModeContainer) {
                studyModeContainer.classList.add('hidden');
            }
            
            document.querySelectorAll('.module-content').forEach(el => el.classList.add('hidden'));
            const moduleEl = document.getElementById('module-' + moduleName);
            if (moduleEl) {
                moduleEl.classList.remove('hidden');
            }
            
            // Render tasks module if switching to it
            if (moduleName === 'tasks') {
                renderTasksModule();
            }
            
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-300', 'hover:bg-gray-700');
            });
            
            const activeBtn = document.getElementById('nav-' + moduleName);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-300', 'hover:bg-gray-700');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
            
            // Only reset study mode state if NOT going to flashcards
            if (moduleName !== 'flashcards' && appState.studyMode.active) {
                // Save lastStudied timestamp when leaving
                if (appState.studyMode.deckId) {
                    const deck = appState.flashcardDecks.find(d => d.id === appState.studyMode.deckId);
                    if (deck) {
                        deck.lastStudied = Date.now();
                    }
                }
                appState.studyMode = {
                    active: false,
                    deckId: null,
                    currentCardIndex: 0,
                    showingBack: false,
                    answerChecked: false
                };
            }
            
            if (moduleName === 'flashcards') {
                // Ensure we show decks, not study mode
                if (studyModeContainer) {
                    studyModeContainer.classList.add('hidden');
                }
                renderDecks();
            }
            
            // Update mini-timer visibility
            updateMiniTimerVisibility();
            
            // Update motivator when viewing dashboard
            if (moduleName === 'dashboard') {
                updateMotivator();
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function updateGreeting() {
            try {
                const hour = new Date().getHours();
                let greeting = 'Good evening';
                
                if (hour >= 5 && hour < 12) {
                    greeting = 'Good morning';
                } else if (hour >= 12 && hour < 18) {
                    greeting = 'Good afternoon';
                }
                
                const greetingEl = document.getElementById('greeting');
                if (greetingEl) greetingEl.textContent = greeting;
            } catch (error) {
                console.error('Error updating greeting:', error);
            }
        }

        function updateDateTime() {
            try {
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateEl = document.getElementById('currentDate');
                if (dateEl) dateEl.textContent = now.toLocaleDateString('en-US', options);
            } catch (error) {
                console.error('Error updating date/time:', error);
            }
        }

        function generateId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== QUICK LINKS =====
        function renderQuickLinks() {
            const container = document.getElementById('quickLinksGrid');
            if (!container) return;
            container.innerHTML = '';
            
            appState.quickLinks.forEach(link => {
                const linkEl = document.createElement('a');
                linkEl.href = link.url;
                linkEl.target = '_blank';
                linkEl.className = 'group relative bg-gray-100 hover:bg-gray-200 p-4 rounded-lg transition flex flex-col items-center justify-center text-center min-h-[100px]';
                linkEl.innerHTML = `
                    <span class="text-3xl mb-2">${escapeHtml(link.icon)}</span>
                    <span class="text-sm text-gray-900 font-medium">${escapeHtml(link.name)}</span>
                    <button onclick="deleteQuickLink(event, '${link.id}')" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                        √ó
                    </button>
                `;
                container.appendChild(linkEl);
            });
        }

        function openAddLinkModal() {
            const modal = document.getElementById('addLinkModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const input = document.getElementById('newLinkName');
            if (input) input.focus();
        }

        function closeAddLinkModal() {
            const modal = document.getElementById('addLinkModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const name = document.getElementById('newLinkName');
            if (name) name.value = '';
            const url = document.getElementById('newLinkUrl');
            if (url) url.value = '';
            const icon = document.getElementById('newLinkIcon');
            if (icon) icon.value = '';
        }

        function addQuickLink() {
            const name = document.getElementById('newLinkName').value.trim();
            const url = document.getElementById('newLinkUrl').value.trim();
            const icon = document.getElementById('newLinkIcon').value.trim();
            
            if (!name || !url) {
                alert('Please enter both name and URL');
                return;
            }
            
            const newLink = {
                id: generateId(),
                name: name,
                url: url,
                icon: icon || 'üîó'
            };
            
            appState.quickLinks.push(newLink);
            saveState('quick_link_added');
            renderQuickLinks();
            closeAddLinkModal();
        }

        function deleteQuickLink(event, linkId) {
            event.preventDefault();
            event.stopPropagation();
            
            if (confirm('Delete this link?')) {
                appState.quickLinks = appState.quickLinks.filter(l => l.id !== linkId);
                saveState('quick_link_deleted');
                renderQuickLinks();
            }
        }

        // ===== TASK DATA MIGRATION =====
        function runTaskMigration() {
            let migrated = false;
            appState.tasks.forEach(task => {
                if (!task.hasOwnProperty('description')) {
                    task.description = '';
                    migrated = true;
                }
                if (!task.hasOwnProperty('domain')) {
                    task.domain = '';
                    migrated = true;
                }
            });
            if (migrated) {
                saveState();
                console.log('Task migration completed');
            }
        }

        // ===== TASK VIEW MODES =====
        function setTasksView(mode) {
            appState.tasksViewMode = mode;
            saveState('view_mode_changed');
            renderTasksModule();
            
            // Update button styles
            const buttons = ['kanban', 'calendar', 'list'];
            buttons.forEach(btn => {
                const btnEl = document.getElementById('taskView-' + btn);
                if (btnEl) {
                    if (btn === mode) {
                        btnEl.className = 'px-4 py-2 rounded-lg font-medium transition';
                        btnEl.style.backgroundColor = 'var(--accent-primary)';
                        btnEl.style.color = 'white';
                    } else {
                        btnEl.className = 'px-4 py-2 rounded-lg font-medium transition';
                        btnEl.style.backgroundColor = 'var(--bg-tertiary)';
                        btnEl.style.color = 'var(--text-primary)';
                    }
                }
            });
        }

        function renderTasksModule() {
            const container = document.getElementById('tasksViewContainer');
            if (!container) return;
            
            if (appState.tasksViewMode === 'kanban') {
                renderKanbanView(container);
            } else if (appState.tasksViewMode === 'calendar') {
                renderCalendarView(container);
            } else if (appState.tasksViewMode === 'list') {
                renderListView(container);
            }
        }

        // ===== KANBAN BOARD =====
        function renderKanbanView(container) {
            const template = document.getElementById('kanbanTemplate');
            if (!template) return;
            container.innerHTML = template.innerHTML;
            
            renderKanbanBoard();
        }

        function renderKanbanBoard() {
            const columns = ['todo', 'inprogress', 'done'];
            
            columns.forEach(column => {
                const columnEl = document.getElementById(column + 'Column');
                if (!columnEl) return;
                columnEl.innerHTML = '';
                
                const columnTasks = appState.tasks.filter(task => task.column === column);
                
                columnTasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    columnEl.appendChild(taskCard);
                });
                
                const countEl = document.getElementById(column + 'Count');
                if (countEl) {
                    countEl.textContent = `(${columnTasks.length})`;
                }
            });

            setupDragAndDrop();
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'bg-gray-100 p-3 rounded-lg cursor-move hover:shadow-md transition group border border-gray-200';
            card.draggable = true;
            card.dataset.taskId = task.id;
            
            let dueDateHtml = '';
            if (task.dueDate) {
                const dueDate = new Date(task.dueDate);
                const formattedDate = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dueDateHtml = `<p class="text-xs text-gray-600 mt-1">üìÖ Due: ${formattedDate}</p>`;
            }
            
            card.innerHTML = `
                <div class="flex justify-between items-start gap-2">
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">${escapeHtml(task.text)}</p>
                        ${dueDateHtml}
                    </div>
                    <button onclick="deleteTask('${task.id}')" class="text-red-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            
            return card;
        }

        function setupDragAndDrop() {
            try {
                const cards = document.querySelectorAll('[draggable="true"]');
                const columns = document.querySelectorAll('.kanban-column');
                
                if (!cards || !columns) return;
            
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });
            
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('drop', handleDrop);
                column.addEventListener('dragleave', handleDragLeave);
            });
            } catch (error) {
                console.error('Error setting up drag and drop:', error);
            }
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.dataset.taskId);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            e.currentTarget.classList.remove('drag-over');
            
            const taskId = e.dataTransfer.getData('text/html');
            const newColumn = e.currentTarget.dataset.column;
            
            const taskIndex = appState.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                appState.tasks[taskIndex].column = newColumn;
                autoSave('task_moved');
                renderKanbanBoard();
                buildDailySyllabus();
            }
            
            return false;
        }

        function openAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const input = document.getElementById('newTaskInput');
            if (input) input.focus();
        }

        function closeAddTaskModal() {
            const modal = document.getElementById('addTaskModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const input = document.getElementById('newTaskInput');
            if (input) input.value = '';
            const desc = document.getElementById('newTaskDescription');
            if (desc) desc.value = '';
            const domain = document.getElementById('newTaskDomain');
            if (domain) domain.value = '';
            const date = document.getElementById('newTaskDueDate');
            if (date) date.value = '';
        }

        function addTask() {
            const input = document.getElementById('newTaskInput');
            const taskText = input.value.trim();
            const dueDateInput = document.getElementById('newTaskDueDate');
            const dueDate = dueDateInput.value || null;
            
            if (!taskText) {
                input.classList.add('input-error');
                let errorEl = document.getElementById('error-newTaskInput');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'error-newTaskInput';
                    errorEl.className = 'error-message show';
                    errorEl.textContent = 'Task description required';
                    input.parentNode.insertBefore(errorEl, input.nextSibling);
                } else {
                    errorEl.classList.add('show');
                }
                return;
            } else {
                input.classList.remove('input-error');
                const errorEl = document.getElementById('error-newTaskInput');
                if (errorEl) errorEl.classList.remove('show');
            }
            
            const description = document.getElementById('newTaskDescription')?.value?.trim() || '';
            const domain = document.getElementById('newTaskDomain')?.value?.trim() || '';
            
            const newTask = {
                id: generateId(),
                text: taskText,
                description: description,
                domain: domain,
                column: 'todo',
                dueDate: dueDate,
                createdAt: Date.now()
            };
            
            appState.tasks.push(newTask);
            saveState('task_added');
            renderKanbanBoard();
            buildDailySyllabus();
            closeAddTaskModal();
        }

        function deleteTask(taskId) {
            if (!taskId) return;
            if (confirm('Delete this task?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                saveState('task_deleted');
                if (appState.currentModule === 'tasks') {
                    renderTasksModule();
                }
                buildDailySyllabus();
            }
        }

        // ===== TASK CALENDAR VIEW =====
        function renderCalendarView(container) {
            const { year, month } = appState.tasksCalendarMonth;
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            const nextMonthDays = 42 - (daysInMonth + startDay);
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            let html = `
                <div class="rounded-xl shadow-sm border p-6" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="navigateCalendar(-1)" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">‚Üê Previous</button>
                        <h3 class="text-2xl font-bold" style="color: var(--text-primary);">${monthNames[month]} ${year}</h3>
                        <button onclick="navigateCalendar(1)" class="px-4 py-2 rounded-lg transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">Next ‚Üí</button>
                    </div>
                    <div class="grid grid-cols-7 gap-2">
            `;
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="text-center font-semibold py-2" style="color: var(--text-secondary);">${day}</div>`;
            });
            
            const today = getTodayDateString();
            
            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                html += `<div class="p-2 min-h-[100px] rounded-lg" style="background-color: var(--bg-secondary); opacity: 0.5;">
                    <div class="text-sm" style="color: var(--text-tertiary);">${day}</div>
                </div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === today;
                const tasksForDay = appState.tasks.filter(t => t.dueDate === dateStr);
                
                html += `<div class="p-2 min-h-[100px] rounded-lg border" style="background-color: var(--bg-card); border-color: ${isToday ? 'var(--accent-primary)' : 'var(--border-color)'}; border-width: ${isToday ? '2px' : '1px'};">
                    <div class="text-sm font-semibold mb-1" style="color: ${isToday ? 'var(--accent-primary)' : 'var(--text-primary)'};">${day}</div>
                    <div class="space-y-1">`;
                
                tasksForDay.slice(0, 3).forEach(task => {
                    const color = task.column === 'done' ? 'var(--success)' : task.column === 'inprogress' ? 'var(--warning)' : 'var(--accent-primary)';
                    html += `<div onclick="openTaskModal('${task.id}')" class="text-xs px-2 py-1 rounded cursor-pointer" style="background-color: ${color}; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(task.text)}">
                        ${escapeHtml(task.text.substring(0, 20))}${task.text.length > 20 ? '...' : ''}
                    </div>`;
                });
                
                if (tasksForDay.length > 3) {
                    html += `<div class="text-xs" style="color: var(--text-secondary);">+${tasksForDay.length - 3} more</div>`;
                }
                
                html += `</div></div>`;
            }
            
            // Next month days
            for (let day = 1; day <= nextMonthDays; day++) {
                html += `<div class="p-2 min-h-[100px] rounded-lg" style="background-color: var(--bg-secondary); opacity: 0.5;">
                    <div class="text-sm" style="color: var(--text-tertiary);">${day}</div>
                </div>`;
            }
            
            html += `</div></div>`;
            
            if (appState.tasks.filter(t => t.dueDate).length === 0) {
                html += `<div class="text-center py-8" style="color: var(--text-secondary);">Add due dates to tasks to see them on the calendar</div>`;
            }
            
            container.innerHTML = html;
        }

        function navigateCalendar(direction) {
            appState.tasksCalendarMonth.month += direction;
            if (appState.tasksCalendarMonth.month > 11) {
                appState.tasksCalendarMonth.month = 0;
                appState.tasksCalendarMonth.year++;
            } else if (appState.tasksCalendarMonth.month < 0) {
                appState.tasksCalendarMonth.month = 11;
                appState.tasksCalendarMonth.year--;
            }
            saveState('calendar_navigated');
            renderTasksModule();
        }

        // ===== TASK LIST VIEW =====
        function getDomainColor(domain) {
            if (!domain) return '';
            const colors = [
                'bg-blue-100 text-blue-800',
                'bg-purple-100 text-purple-800',
                'bg-pink-100 text-pink-800',
                'bg-indigo-100 text-indigo-800',
                'bg-cyan-100 text-cyan-800',
                'bg-teal-100 text-teal-800'
            ];
            const hash = domain.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colors[hash % colors.length];
        }

        function getStatusBadge(column) {
            const badges = {
                todo: { label: 'not started', class: 'bg-red-100 text-red-800' },
                inprogress: { label: 'in progress', class: 'bg-orange-100 text-orange-800' },
                done: { label: 'done', class: 'bg-green-100 text-green-800' }
            };
            return badges[column] || badges.todo;
        }

        function calculateDaysLeft(dueDate) {
            if (!dueDate) return null;
            const days = getDaysDifference(dueDate);
            return days;
        }

        function renderListView(container) {
            const sortedTasks = [...appState.tasks].sort((a, b) => {
                const { column, direction } = appState.tasksListSort;
                let aVal, bVal;
                
                if (column === 'daysLeft') {
                    aVal = calculateDaysLeft(a.dueDate) ?? 999999;
                    bVal = calculateDaysLeft(b.dueDate) ?? 999999;
                } else if (column === 'dueDate') {
                    aVal = a.dueDate || '9999-12-31';
                    bVal = b.dueDate || '9999-12-31';
                } else {
                    aVal = (a[column] || '').toLowerCase();
                    bVal = (b[column] || '').toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            let html = `
                <div class="rounded-xl shadow-sm border overflow-hidden" style="background-color: var(--bg-card); border-color: var(--border-color);">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead style="background-color: var(--bg-secondary);">
                                <tr>
                                    <th onclick="sortListView('text')" class="px-4 py-3 text-left cursor-pointer hover:opacity-70" style="color: var(--text-primary); width: 30%;">lecture/assignment ‚ñº</th>
                                    <th onclick="sortListView('domain')" class="px-4 py-3 text-left cursor-pointer hover:opacity-70" style="color: var(--text-primary); width: 20%;">domain ‚ñº</th>
                                    <th onclick="sortListView('dueDate')" class="px-4 py-3 text-left cursor-pointer hover:opacity-70" style="color: var(--text-primary); width: 15%;">date ‚ñº</th>
                                    <th onclick="sortListView('daysLeft')" class="px-4 py-3 text-left cursor-pointer hover:opacity-70" style="color: var(--text-primary); width: 15%;">due date ‚ñº</th>
                                    <th onclick="sortListView('column')" class="px-4 py-3 text-left cursor-pointer hover:opacity-70" style="color: var(--text-primary); width: 20%;">Status ‚ñº</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (sortedTasks.length === 0) {
                html += `<tr><td colspan="5" class="px-4 py-8 text-center" style="color: var(--text-secondary);">No tasks yet</td></tr>`;
            } else {
                sortedTasks.forEach((task, index) => {
                    const daysLeft = calculateDaysLeft(task.dueDate);
                    const statusBadge = getStatusBadge(task.column);
                    const domainColor = getDomainColor(task.domain);
                    
                    let daysLeftText = '-';
                    let daysLeftColor = 'var(--text-secondary)';
                    if (daysLeft !== null) {
                        if (daysLeft < 0) {
                            daysLeftText = `${Math.abs(daysLeft)} day(s) overdue`;
                            daysLeftColor = 'var(--danger)';
                        } else if (daysLeft === 0) {
                            daysLeftText = 'Due today';
                            daysLeftColor = 'var(--warning)';
                        } else if (daysLeft <= 3) {
                            daysLeftText = `${daysLeft} day(s) left`;
                            daysLeftColor = 'var(--warning)';
                        } else {
                            daysLeftText = `${daysLeft} day(s) left`;
                            daysLeftColor = 'var(--success)';
                        }
                    }
                    
                    const dateDisplay = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '-';
                    
                    html += `
                        <tr onclick="openTaskModal('${task.id}')" class="cursor-pointer hover:opacity-70 border-t" style="border-color: var(--border-color); background-color: ${index % 2 === 0 ? 'var(--bg-card)' : 'var(--bg-secondary)'}">
                            <td class="px-4 py-3" style="color: var(--text-primary);">${escapeHtml(task.text)}</td>
                            <td class="px-4 py-3">${task.domain ? `<span class="${domainColor} px-2 py-1 rounded-full text-xs font-medium">${escapeHtml(task.domain)}</span>` : '-'}</td>
                            <td class="px-4 py-3" style="color: var(--text-secondary);">${dateDisplay}</td>
                            <td class="px-4 py-3 font-semibold" style="color: ${daysLeftColor};">${daysLeftText}</td>
                            <td class="px-4 py-3"><span class="${statusBadge.class} px-2 py-1 rounded-full text-xs font-medium">${statusBadge.label}</span></td>
                        </tr>
                    `;
                });
            }
            
            html += `</tbody></table></div></div>`;
            container.innerHTML = html;
        }

        function sortListView(column) {
            if (appState.tasksListSort.column === column) {
                appState.tasksListSort.direction = appState.tasksListSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                appState.tasksListSort.column = column;
                appState.tasksListSort.direction = 'asc';
            }
            saveState('list_sorted');
            renderTasksModule();
        }

        // ===== TASK MODAL =====
        function openTaskModal(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            
            const statusBadge = getStatusBadge(task.column);
            const domainColor = getDomainColor(task.domain);
            
            document.getElementById('modalTaskTitle').textContent = task.text;
            document.getElementById('modalTaskDomain').innerHTML = task.domain ? `<span class="${domainColor} px-3 py-1 rounded-full text-sm font-medium">${escapeHtml(task.domain)}</span>` : '<span style="color: var(--text-secondary);">No domain set</span>';
            document.getElementById('modalTaskDueDate').textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'No due date';
            document.getElementById('modalTaskStatus').innerHTML = `<span class="${statusBadge.class} px-3 py-1 rounded-full text-sm font-medium">${statusBadge.label}</span>`;
            document.getElementById('modalTaskDescription').textContent = task.description || 'No description';
            
            const statusSelect = document.getElementById('modalTaskStatusSelect');
            if (statusSelect) {
                statusSelect.value = task.column;
            }
            
            modal.dataset.taskId = taskId;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function updateTaskStatus() {
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            
            const taskId = modal.dataset.taskId;
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const statusSelect = document.getElementById('modalTaskStatusSelect');
            if (statusSelect) {
                task.column = statusSelect.value;
                saveState('task_edited');
                renderTasksModule();
                buildDailySyllabus();
                closeTaskModal();
            }
        }

        function deleteTaskFromModal() {
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            
            const taskId = modal.dataset.taskId;
            if (confirm('Delete this task?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                saveState('task_deleted');
                renderTasksModule();
                buildDailySyllabus();
                closeTaskModal();
            }
        }

        // ===== GRADE TRACKER =====
        function renderCourses() {
            const container = document.getElementById('coursesContainer');
            if (!container) return;
            
            if (appState.courses.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No courses yet. Click "Add Course" to get started.</p>';
                return;
            }
            
            container.innerHTML = '';
            
            appState.courses.forEach(course => {
                const courseCard = document.createElement('div');
                courseCard.className = 'bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden';
                
                const weightedGrade = calculateWeightedGrade(course);
                
                courseCard.innerHTML = `
                    <div class="p-5 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition" onclick="toggleCourse('${course.id}')">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${escapeHtml(course.name)}</h3>
                            <p class="text-sm text-gray-600 mt-1">Current Grade: <span class="font-semibold text-blue-600">${weightedGrade}</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="deleteCourse(event, '${course.id}')" class="text-red-500 hover:text-red-600 px-3 py-1 rounded transition">
                                Delete
                            </button>
                            <svg class="w-5 h-5 text-gray-400 transform transition" id="arrow-${course.id}">
                                <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </div>
                    </div>
                    <div id="course-${course.id}" class="hidden p-5 bg-gray-50 border-t border-gray-200">
                        <div class="mb-4 flex gap-2">
                            <button onclick="openAddAssignmentModal('${course.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm">
                                + Add Assignment
                            </button>
                            <button onclick="openAddKeyDateModal('${course.id}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm">
                                + Add Key Date
                            </button>
                        </div>
                        <div id="keyDates-${course.id}" class="mb-4"></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-200">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-gray-900 font-semibold">Assignment</th>
                                        <th class="px-4 py-2 text-center text-gray-900 font-semibold">Weight (%)</th>
                                        <th class="px-4 py-2 text-center text-gray-900 font-semibold">Score (%)</th>
                                        <th class="px-4 py-2 text-center text-gray-900 font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assignments-${course.id}">
                                    ${course.assignments.length === 0 ? '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">No assignments yet</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                container.appendChild(courseCard);
                
                // Render key dates
                renderKeyDates(course);
                
                if (course.assignments.length > 0) {
                    const tbody = document.getElementById('assignments-' + course.id);
                    tbody.innerHTML = '';
                    course.assignments.forEach(assignment => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-gray-900">${escapeHtml(assignment.name)}</td>
                            <td class="px-4 py-3 text-center text-gray-900">${assignment.weight}%</td>
                            <td class="px-4 py-3 text-center text-gray-900">${assignment.score}%</td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="deleteAssignment('${course.id}', '${assignment.id}')" class="text-red-500 hover:text-red-600 text-xs">
                                    Delete
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            });
        }

        function calculateWeightedGrade(course) {
            if (course.assignments.length === 0) return 'N/A';
            
            let totalWeightedScore = 0;
            let totalWeight = 0;
            
            course.assignments.forEach(assignment => {
                totalWeightedScore += (assignment.weight * assignment.score) / 100;
                totalWeight += assignment.weight;
            });
            
            if (totalWeight === 0) return 'N/A';
            
            const grade = (totalWeightedScore / totalWeight) * 100;
            return grade.toFixed(2) + '%';
        }

        function toggleCourse(courseId) {
            const courseContent = document.getElementById('course-' + courseId);
            const arrow = document.getElementById('arrow-' + courseId);
            
            if (!courseContent || !arrow) return;
            
            if (courseContent.classList.contains('hidden')) {
                courseContent.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                courseContent.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function openAddCourseModal() {
            const modal = document.getElementById('addCourseModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const input = document.getElementById('newCourseName');
            if (input) input.focus();
        }

        function closeAddCourseModal() {
            const modal = document.getElementById('addCourseModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const input = document.getElementById('newCourseName');
            if (input) input.value = '';
        }

        function addCourse() {
            const name = document.getElementById('newCourseName').value.trim();
            
            if (!name) {
                alert('Please enter a course name');
                return;
            }
            
            const newCourse = {
                id: generateId(),
                name: name,
                assignments: [],
                keyDates: []
            };
            
            appState.courses.push(newCourse);
            saveState('course_added');
            renderCourses();
            buildDailySyllabus();
            closeAddCourseModal();
        }

        function deleteCourse(event, courseId) {
            event.stopPropagation();
            
            if (confirm('Delete this course and all its assignments?')) {
                appState.courses = appState.courses.filter(c => c.id !== courseId);
                saveState('course_deleted');
                renderCourses();
            }
        }

        function openAddAssignmentModal(courseId) {
            appState.currentCourseId = courseId;
            document.getElementById('addAssignmentModal').classList.remove('hidden');
            document.getElementById('addAssignmentModal').classList.add('flex');
            document.getElementById('newAssignmentName').focus();
        }

        function closeAddAssignmentModal() {
            const modal = document.getElementById('addAssignmentModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const name = document.getElementById('newAssignmentName');
            if (name) name.value = '';
            const weight = document.getElementById('newAssignmentWeight');
            if (weight) weight.value = '';
            const score = document.getElementById('newAssignmentScore');
            if (score) score.value = '';
            appState.currentCourseId = null;
        }

        function addAssignment() {
            const name = document.getElementById('newAssignmentName').value.trim();
            const weightInput = document.getElementById('newAssignmentWeight');
            const scoreInput = document.getElementById('newAssignmentScore');
            
            const weight = parseFloat(weightInput.value);
            const score = parseFloat(scoreInput.value);
            
            if (!name) {
                alert('Please enter an assignment name');
                return;
            }
            
            const weightValid = validateGradeInput(weightInput, 0, 100, 'Weight');
            const scoreValid = validateGradeInput(scoreInput, 0, 100, 'Score');
            
            if (!weightValid || !scoreValid) {
                return;
            }
            
            const course = appState.courses.find(c => c.id === appState.currentCourseId);
            if (course) {
                const newAssignment = {
                    id: generateId(),
                    name: name,
                    weight: weight,
                    score: score
                };
                
                course.assignments.push(newAssignment);
                saveState('assignment_added');
                renderCourses();
                closeAddAssignmentModal();
            }
        }

        function deleteAssignment(courseId, assignmentId) {
            if (confirm('Delete this assignment?')) {
                const course = appState.courses.find(c => c.id === courseId);
                if (course) {
                    course.assignments = course.assignments.filter(a => a.id !== assignmentId);
                    saveState('assignment_deleted');
                    renderCourses();
                }
            }
        }

        function openAddKeyDateModal(courseId) {
            appState.currentCourseId = courseId;
            document.getElementById('addKeyDateModal').classList.remove('hidden');
            document.getElementById('addKeyDateModal').classList.add('flex');
            document.getElementById('newKeyDateLabel').focus();
        }

        function closeAddKeyDateModal() {
            const modal = document.getElementById('addKeyDateModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const label = document.getElementById('newKeyDateLabel');
            if (label) label.value = '';
            const date = document.getElementById('newKeyDateDate');
            if (date) date.value = '';
            appState.currentCourseId = null;
        }

        function addKeyDate() {
            const label = document.getElementById('newKeyDateLabel').value.trim();
            const date = document.getElementById('newKeyDateDate').value;
            
            if (!label || !date) {
                alert('Please fill in both label and date');
                return;
            }
            
            const course = appState.courses.find(c => c.id === appState.currentCourseId);
            if (course) {
                if (!course.keyDates) course.keyDates = [];
                
                const newKeyDate = {
                    id: generateId(),
                    label: label,
                    date: date
                };
                
                course.keyDates.push(newKeyDate);
                saveState('key_date_added');
                renderCourses();
                buildDailySyllabus();
                closeAddKeyDateModal();
            }
        }

        function deleteKeyDate(courseId, keyDateId) {
            if (confirm('Delete this key date?')) {
                const course = appState.courses.find(c => c.id === courseId);
                if (course) {
                    course.keyDates = course.keyDates.filter(k => k.id !== keyDateId);
                    saveState('key_date_deleted');
                    renderCourses();
                    buildDailySyllabus();
                }
            }
        }

        function renderKeyDates(course) {
            if (!course || !course.id) return;
            const container = document.getElementById('keyDates-' + course.id);
            if (!container) return;
            
            if (!course.keyDates || course.keyDates.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<h4 class="font-semibold text-gray-900 mb-2 text-sm">Key Dates:</h4>';
            const datesDiv = document.createElement('div');
            datesDiv.className = 'space-y-2 mb-4';
            
            course.keyDates.forEach(keyDate => {
                const dateEl = document.createElement('div');
                dateEl.className = 'flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200';
                const dateObj = new Date(keyDate.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                dateEl.innerHTML = `
                    <div>
                        <span class="font-medium text-gray-900">${escapeHtml(keyDate.label)}</span>
                        <span class="text-sm text-gray-600 ml-2">üìÖ ${formattedDate}</span>
                    </div>
                    <button onclick="deleteKeyDate('${course.id}', '${keyDate.id}')" class="text-red-500 hover:text-red-600 text-xs">
                        Delete
                    </button>
                `;
                datesDiv.appendChild(dateEl);
            });
            
            container.appendChild(datesDiv);
        }

        // ===== FLASHCARDS =====
        function renderDecks() {
            const container = document.getElementById('decksContainer');
            if (!container) return;
            
            if (appState.flashcardDecks.length === 0) {
                container.innerHTML = '<div class="col-span-full text-gray-500 text-center py-8">No decks yet. Click "Add Deck" to get started.</div>';
                return;
            }
            
            container.innerHTML = '';
            
            appState.flashcardDecks.forEach(deck => {
                const deckCard = document.createElement('div');
                deckCard.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition';
                
                deckCard.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${escapeHtml(deck.name)}</h3>
                        <p class="text-sm text-gray-600">${deck.cards.length} card${deck.cards.length !== 1 ? 's' : ''}</p>
                    </div>
                    <div class="space-y-2">
                        <button onclick="viewDeck('${deck.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
                            Manage Cards
                        </button>
                        <button onclick="startStudyMode('${deck.id}')" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium" ${deck.cards.length === 0 ? 'disabled' : ''}>
                            Study This Deck
                        </button>
                        <button onclick="deleteDeck('${deck.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm font-medium">
                            Delete Deck
                        </button>
                    </div>
                `;
                
                container.appendChild(deckCard);
            });
        }

        function openAddDeckModal() {
            const modal = document.getElementById('addDeckModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const input = document.getElementById('newDeckName');
            if (input) input.focus();
        }

        function closeAddDeckModal() {
            const modal = document.getElementById('addDeckModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const input = document.getElementById('newDeckName');
            if (input) input.value = '';
        }

        function addDeck() {
            const input = document.getElementById('newDeckName');
            const name = input.value.trim();
            
            if (!name) {
                input.classList.add('input-error');
                let errorEl = document.getElementById('error-newDeckName');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'error-newDeckName';
                    errorEl.className = 'error-message show';
                    errorEl.textContent = 'Deck name required';
                    input.parentNode.insertBefore(errorEl, input.nextSibling);
                } else {
                    errorEl.classList.add('show');
                }
                return;
            } else {
                input.classList.remove('input-error');
                const errorEl = document.getElementById('error-newDeckName');
                if (errorEl) errorEl.classList.remove('show');
            }
            
            const newDeck = {
                id: generateId(),
                name: name,
                cards: [],
                lastStudied: null
            };
            
            appState.flashcardDecks.push(newDeck);
            saveState('deck_created');
            renderDecks();
            closeAddDeckModal();
        }

        function deleteDeck(deckId) {
            if (confirm('Delete this deck and all its cards? This cannot be undone.')) {
                // Check if this deck is currently being studied
                if (appState.studyMode.active && appState.studyMode.deckId === deckId) {
                    exitStudyMode();
                }
                
                // Filter out the deck by ID
                appState.flashcardDecks = appState.flashcardDecks.filter(d => d.id !== deckId);
                saveState('deck_deleted');
                renderDecks();
                buildDailySyllabus();
                
                // Show success feedback
                showToast('üóëÔ∏è Deck Deleted', 'The deck has been removed successfully.');
            }
        }

        function viewDeck(deckId) {
            appState.currentDeckId = deckId;
            const deck = appState.flashcardDecks.find(d => d.id === deckId);
            
            if (!deck) return;
            
            const container = document.getElementById('decksContainer');
            if (!container) return;
            container.innerHTML = `
                <div class="col-span-full">
                    <button onclick="renderDecks()" class="text-blue-600 hover:text-blue-700 font-medium mb-4">
                        ‚Üê Back to Decks
                    </button>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-gray-900">${escapeHtml(deck.name)}</h3>
                            <button onclick="openAddCardModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition font-medium">
                                + Add Card
                            </button>
                        </div>
                        <div class="space-y-3" id="cardsList">
                            ${deck.cards.length === 0 ? '<p class="text-gray-500 text-center py-8">No cards yet</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            if (deck.cards.length > 0) {
                const cardsList = document.getElementById('cardsList');
                cardsList.innerHTML = '';
                deck.cards.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200';
                    cardEl.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1">
                                <p class="text-sm font-semibold text-gray-700 mb-1">Front:</p>
                                <p class="text-sm text-gray-900 mb-3">${escapeHtml(card.front)}</p>
                                <p class="text-sm font-semibold text-gray-700 mb-1">Back:</p>
                                <p class="text-sm text-gray-900">${escapeHtml(card.back)}</p>
                            </div>
                            <button onclick="deleteCard('${deck.id}', '${card.id}')" class="text-red-500 hover:text-red-600 flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    `;
                    cardsList.appendChild(cardEl);
                });
            }
        }

        function openAddCardModal() {
            const modal = document.getElementById('addCardModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const input = document.getElementById('newCardFront');
            if (input) input.focus();
        }

        function closeAddCardModal() {
            const modal = document.getElementById('addCardModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            const front = document.getElementById('newCardFront');
            if (front) front.value = '';
            const back = document.getElementById('newCardBack');
            if (back) back.value = '';
        }

        function addCard() {
            const frontInput = document.getElementById('newCardFront');
            const backInput = document.getElementById('newCardBack');
            const front = frontInput.value.trim();
            const back = backInput.value.trim();
            
            let valid = true;
            
            if (!front) {
                frontInput.classList.add('input-error');
                let errorEl = document.getElementById('error-newCardFront');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'error-newCardFront';
                    errorEl.className = 'error-message show';
                    errorEl.textContent = 'Front of card required';
                    frontInput.parentNode.insertBefore(errorEl, frontInput.nextSibling);
                } else {
                    errorEl.classList.add('show');
                }
                valid = false;
            } else {
                frontInput.classList.remove('input-error');
                const errorEl = document.getElementById('error-newCardFront');
                if (errorEl) errorEl.classList.remove('show');
            }
            
            if (!back) {
                backInput.classList.add('input-error');
                let errorEl = document.getElementById('error-newCardBack');
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'error-newCardBack';
                    errorEl.className = 'error-message show';
                    errorEl.textContent = 'Back of card required';
                    backInput.parentNode.insertBefore(errorEl, backInput.nextSibling);
                } else {
                    errorEl.classList.add('show');
                }
                valid = false;
            } else {
                backInput.classList.remove('input-error');
                const errorEl = document.getElementById('error-newCardBack');
                if (errorEl) errorEl.classList.remove('show');
            }
            
            if (!valid) return;
            
            const deck = appState.flashcardDecks.find(d => d.id === appState.currentDeckId);
            if (deck) {
                const newCard = {
                    id: generateId(),
                    front: front,
                    back: back
                };
                
                deck.cards.push(newCard);
                saveState('card_added');
                viewDeck(appState.currentDeckId);
                closeAddCardModal();
            }
        }

        function deleteCard(deckId, cardId) {
            if (confirm('Delete this card?')) {
                const deck = appState.flashcardDecks.find(d => d.id === deckId);
                if (deck) {
                    deck.cards = deck.cards.filter(c => c.id !== cardId);
                    saveState('card_deleted');
                    viewDeck(deckId);
                }
            }
        }

        // ===== STUDY MODE =====
        function startStudyMode(deckId) {
            const deck = appState.flashcardDecks.find(d => d.id === deckId);
            
            if (!deck || deck.cards.length === 0) {
                alert('This deck has no cards to study');
                return;
            }
            
            appState.studyMode = {
                active: true,
                deckId: deckId,
                currentCardIndex: 0,
                showingBack: false
            };
            
            document.getElementById('module-flashcards').classList.add('hidden');
            document.getElementById('studyModeContainer').classList.remove('hidden');
            
            displayCurrentCard();
        }



        function nextCard() {
            const deck = appState.flashcardDecks.find(d => d.id === appState.studyMode.deckId);
            if (!deck || !deck.cards) return;
            
            if (appState.studyMode.currentCardIndex < deck.cards.length - 1) {
                appState.studyMode.currentCardIndex++;
                displayCurrentCard();
            }
        }

        function previousCard() {
            if (appState.studyMode.currentCardIndex > 0) {
                appState.studyMode.currentCardIndex--;
                displayCurrentCard();
            }
        }

        function exitStudyMode() {
            // Save lastStudied timestamp
            if (appState.studyMode.deckId) {
                const deck = appState.flashcardDecks.find(d => d.id === appState.studyMode.deckId);
                if (deck) {
                    deck.lastStudied = Date.now();
                    saveState('study_completed');
                }
            }
            
            appState.studyMode = {
                active: false,
                deckId: null,
                currentCardIndex: 0,
                showingBack: false,
                answerChecked: false
            };
            
            document.getElementById('studyModeContainer').classList.add('hidden');
            document.getElementById('module-flashcards').classList.remove('hidden');
            renderDecks();
            buildDailySyllabus();
        }

        // ===== MAIN FOCUS WIDGET =====
        function updateFocusWidget() {
            const inputState = document.getElementById('focusInputState');
            const displayState = document.getElementById('focusDisplayState');
            const input = document.getElementById('mainFocusInput');
            const displayText = document.getElementById('focusDisplayText');
            
            if (appState.dailyFocus && appState.focusIsSet) {
                // State 2: Show focus display
                inputState.classList.add('hidden');
                displayState.classList.remove('hidden');
                displayText.textContent = appState.dailyFocus;
            } else {
                // State 1: Show input
                inputState.classList.remove('hidden');
                displayState.classList.add('hidden');
                input.value = appState.dailyFocus;
            }
        }
        
        function saveFocus() {
            const input = document.getElementById('mainFocusInput');
            const value = input.value.trim();
            
            if (!value) {
                alert('Please enter your main focus');
                return;
            }
            
            appState.dailyFocus = value;
            appState.focusIsSet = true;
            saveState();
            // updateFocusWidget();
            buildDailySyllabus();
        }
        
        function editFocus() {
            appState.focusIsSet = false;
            // updateFocusWidget();
            document.getElementById('mainFocusInput').focus();
        }

        // ===== POMODORO TIMER =====
        const TIMER_MODES = {
            work: { duration: 1500, label: 'Work Session', color: 'blue' },
            short: { duration: 300, label: 'Short Break', color: 'green' },
            long: { duration: 900, label: 'Long Break', color: 'purple' }
        };
        
        function setTimerMode(mode) {
            if (appState.pomodoro.isRunning) {
                if (!confirm('Stop current timer and switch modes?')) {
                    return;
                }
                pauseTimer();
            }
            
            appState.pomodoro.mode = mode;
            appState.pomodoro.remainingSeconds = TIMER_MODES[mode].duration;
            
            // Update mode button styles
            ['work', 'short', 'long'].forEach(m => {
                const btn = document.getElementById('mode-' + m);
                if (m === mode) {
                    btn.className = 'px-6 py-3 rounded-lg font-medium transition bg-blue-600 text-white';
                } else {
                    btn.className = 'px-6 py-3 rounded-lg font-medium transition bg-gray-200 text-gray-900 hover:bg-gray-300';
                }
            });
            
            updateTimerDisplay();
            saveState('timer_mode_changed');
        }
        
        function updateTimerDisplay() {
            try {
                const minutes = Math.floor(appState.pomodoro.remainingSeconds / 60);
                const seconds = appState.pomodoro.remainingSeconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const timerDisplay = document.getElementById('timerDisplay');
                if (timerDisplay) timerDisplay.textContent = timeString;
                
                const modeLabel = document.getElementById('currentModeLabel');
                if (modeLabel && TIMER_MODES[appState.pomodoro.mode]) {
                    modeLabel.textContent = TIMER_MODES[appState.pomodoro.mode].label;
                }
                
                // Update mini-timer
                const miniDisplay = document.getElementById('miniTimerDisplay');
                if (miniDisplay) miniDisplay.textContent = timeString;
                
                const miniMode = document.getElementById('miniTimerMode');
                if (miniMode && TIMER_MODES[appState.pomodoro.mode]) {
                    miniMode.textContent = TIMER_MODES[appState.pomodoro.mode].label.split(' ')[0];
                }
            } catch (error) {
                console.error('Error updating timer display:', error);
            }
        }
        
        function startTimer() {
            if (appState.pomodoro.isRunning) return;
            
            appState.pomodoro.isRunning = true;
            appState.pomodoro.startTime = Date.now();
            
            const startBtn = document.getElementById('startBtn');
            if (startBtn) startBtn.classList.add('hidden');
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) pauseBtn.classList.remove('hidden');
            
            appState.pomodoro.timerInterval = setInterval(() => {
                appState.pomodoro.remainingSeconds--;
                
                if (appState.pomodoro.remainingSeconds <= 0) {
                    timerComplete();
                } else {
                    updateTimerDisplay();
                }
            }, 1000);
            
            updateMiniTimerVisibility();
            autoSave('timer_started');
        }
        
        function pauseTimer() {
            if (!appState.pomodoro.isRunning) return;
            
            appState.pomodoro.isRunning = false;
            clearInterval(appState.pomodoro.timerInterval);
            
            const startBtn = document.getElementById('startBtn');
            if (startBtn) startBtn.classList.remove('hidden');
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) pauseBtn.classList.add('hidden');
            
            updateMiniTimerVisibility();
            autoSave('timer_paused');
        }
        
        function resetTimer() {
            pauseTimer();
            appState.pomodoro.remainingSeconds = TIMER_MODES[appState.pomodoro.mode].duration;
            updateTimerDisplay();
            saveToLocalStorage();
        }
        
        function timerComplete() {
            pauseTimer();
            appState.pomodoro.remainingSeconds = 0;
            updateTimerDisplay();
            
            alert('‚è∞ Timer Complete! ' + TIMER_MODES[appState.pomodoro.mode].label + ' finished!');
            
            resetTimer();
        }
        
        function updateMiniTimerVisibility() {
            const miniTimer = document.getElementById('miniTimer');
            if (!miniTimer) return;
            
            // Show mini-timer if: timer is running AND not on productivity module
            if (appState.pomodoro.isRunning && appState.currentModule !== 'productivity') {
                miniTimer.classList.remove('hidden');
            } else {
                miniTimer.classList.add('hidden');
            }
        }

        // ===== FLASHCARD STUDY MODE WITH ANSWER CHECKING =====
        function displayCurrentCard() {
            const deck = appState.flashcardDecks.find(d => d.id === appState.studyMode.deckId);
            if (!deck || !deck.cards || deck.cards.length === 0) return;
            
            const card = deck.cards[appState.studyMode.currentCardIndex];
            if (!card) return;
            
            const deckNameEl = document.getElementById('studyDeckName');
            if (deckNameEl) deckNameEl.textContent = deck.name;
            const questionEl = document.getElementById('cardQuestion');
            if (questionEl) questionEl.textContent = card.front;
            const progressEl = document.getElementById('cardProgress');
            if (progressEl) progressEl.textContent = `Card ${appState.studyMode.currentCardIndex + 1} of ${deck.cards.length}`;
            
            // Reset answer checking state
            const userAnswerEl = document.getElementById('userAnswer');
            if (userAnswerEl) {
                userAnswerEl.value = '';
                userAnswerEl.disabled = false;
            }
            const answerRevealEl = document.getElementById('answerReveal');
            if (answerRevealEl) answerRevealEl.classList.add('hidden');
            const checkBtnEl = document.getElementById('checkAnswerBtn');
            if (checkBtnEl) checkBtnEl.classList.remove('hidden');
            appState.studyMode.answerChecked = false;
        }
        
        function checkAnswer() {
            if (appState.studyMode.answerChecked) return;
            
            const deck = appState.flashcardDecks.find(d => d.id === appState.studyMode.deckId);
            if (!deck || !deck.cards) return;
            
            const card = deck.cards[appState.studyMode.currentCardIndex];
            if (!card) return;
            const userAnswerEl = document.getElementById('userAnswer');
            const correctAnswerEl = document.getElementById('correctAnswer');
            const answerRevealEl = document.getElementById('answerReveal');
            const checkBtnEl = document.getElementById('checkAnswerBtn');
            
            if (!userAnswerEl || !correctAnswerEl || !answerRevealEl || !checkBtnEl) return;
            
            const userAnswer = userAnswerEl.value.trim().toLowerCase();
            const correctAnswer = card.back.trim().toLowerCase();
            
            // Show correct answer
            correctAnswerEl.textContent = card.back;
            answerRevealEl.classList.remove('hidden');
            checkBtnEl.classList.add('hidden');
            userAnswerEl.disabled = true;
            
            // Provide feedback
            const feedbackEl = document.getElementById('feedbackMessage');
            const isCorrect = userAnswer === correctAnswer;
            
            if (isCorrect) {
                feedbackEl.textContent = '‚úì Correct!';
                feedbackEl.className = 'p-4 rounded-lg text-center font-semibold text-lg bg-green-100 text-green-600';
            } else {
                feedbackEl.textContent = '‚úó Incorrect';
                feedbackEl.className = 'p-4 rounded-lg text-center font-semibold text-lg bg-red-100 text-red-600';
                
                // Optionally show user's answer
                if (userAnswer) {
                    feedbackEl.innerHTML = '‚úó Incorrect<br><span class="text-sm mt-2 block">Your answer: "' + escapeHtml(document.getElementById('userAnswer').value) + '"</span>';
                }
            }
            
            appState.studyMode.answerChecked = true;
        }

        // ===== TODAY'S SYLLABUS =====
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getTomorrowDateString() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const year = tomorrow.getFullYear();
            const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
            const day = String(tomorrow.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDaysDifference(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            date.setHours(0, 0, 0, 0);
            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function getDaysSinceStudied(timestamp) {
            if (!timestamp) return null;
            const studiedDate = new Date(timestamp);
            const today = new Date();
            studiedDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);
            const diffTime = today - studiedDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        function buildDailySyllabus() {
            try {
                const actionCards = [];
            const today = getTodayDateString();
            const tomorrow = getTomorrowDateString();

            // PRIORITY 1: Critical (Due Today)
            // Tasks due today
            appState.tasks.forEach(task => {
                if (task.dueDate === today && task.column !== 'done') {
                    actionCards.push({
                        id: generateId(),
                        type: 'task',
                        priority: 1,
                        title: task.text,
                        description: 'Due today',
                        dueDate: task.dueDate,
                        urgency: 'critical',
                        metadata: { taskId: task.id }
                    });
                }
            });

            // Exams today or tomorrow
            appState.courses.forEach(course => {
                if (course.keyDates) {
                    course.keyDates.forEach(keyDate => {
                        if (keyDate.date === today) {
                            actionCards.push({
                                id: generateId(),
                                type: 'exam',
                                priority: 1,
                                title: `${course.name}: ${keyDate.label}`,
                                description: 'üö® EXAM TODAY',
                                dueDate: keyDate.date,
                                urgency: 'critical',
                                metadata: { courseId: course.id, keyDateId: keyDate.id }
                            });
                        } else if (keyDate.date === tomorrow) {
                            actionCards.push({
                                id: generateId(),
                                type: 'alert',
                                priority: 1,
                                title: `${course.name}: ${keyDate.label}`,
                                description: '‚ö†Ô∏è EXAM TOMORROW',
                                dueDate: keyDate.date,
                                urgency: 'critical',
                                metadata: { courseId: course.id, keyDateId: keyDate.id }
                            });
                        }
                    });
                }
            });

            // PRIORITY 2: Smart Review (Spaced Repetition)
            const spacedIntervals = [1, 3, 7, 14];
            appState.flashcardDecks.forEach(deck => {
                if (deck.lastStudied && deck.cards.length > 0) {
                    const daysSince = getDaysSinceStudied(deck.lastStudied);
                    if (daysSince !== null && spacedIntervals.includes(daysSince)) {
                        let urgency = 'medium';
                        if (daysSince === 1) urgency = 'high';
                        if (daysSince === 3) urgency = 'high';
                        
                        actionCards.push({
                            id: generateId(),
                            type: 'review',
                            priority: 2,
                            title: `Review: ${deck.name}`,
                            description: `Last studied ${daysSince} day${daysSince > 1 ? 's' : ''} ago`,
                            dueDate: null,
                            urgency: urgency,
                            metadata: { deckId: deck.id }
                        });
                    }
                }
            });

            // PRIORITY 3: High Priority (Due Soon)
            appState.tasks.forEach(task => {
                if (task.dueDate && task.column !== 'done') {
                    const daysDiff = getDaysDifference(task.dueDate);
                    if (daysDiff > 0 && daysDiff <= 3) {
                        actionCards.push({
                            id: generateId(),
                            type: 'task',
                            priority: 3,
                            title: task.text,
                            description: `Due in ${daysDiff} day${daysDiff > 1 ? 's' : ''}`,
                            dueDate: task.dueDate,
                            urgency: 'high',
                            metadata: { taskId: task.id }
                        });
                    }
                }
            });

            // PRIORITY 4: Focus & Wellness
            if (appState.dailyFocus && appState.focusIsSet) {
                actionCards.push({
                    id: generateId(),
                    type: 'focus',
                    priority: 4,
                    title: 'Today\'s Main Focus',
                    description: appState.dailyFocus,
                    dueDate: null,
                    urgency: 'low',
                    metadata: {}
                });
            } else {
                actionCards.push({
                    id: generateId(),
                    type: 'focus',
                    priority: 4,
                    title: 'Set Your Main Focus',
                    description: 'What do you want to accomplish today?',
                    dueDate: null,
                    urgency: 'low',
                    metadata: { needsSetup: true }
                });
            }

            actionCards.push({
                id: generateId(),
                type: 'wellness',
                priority: 4,
                title: 'Start Focus Block',
                description: 'Launch Pomodoro timer to maximize productivity',
                dueDate: null,
                urgency: 'low',
                metadata: {}
            });

            // Sort by priority
            actionCards.sort((a, b) => a.priority - b.priority);

                renderSyllabus(actionCards);
            } catch (error) {
                console.error('Error building daily syllabus:', error);
            }
        }

        function renderSyllabus(actionCards) {
            const container = document.getElementById('syllabusContent');
            if (!container) return;
            
            if (actionCards.length === 0) {
                container.innerHTML = '<div class="text-center py-12"><p class="text-2xl text-gray-600">üéâ You\'re all caught up!</p><p class="text-gray-500 mt-2">No urgent tasks or reviews today</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            actionCards.forEach(card => {
                const cardEl = document.createElement('div');
                let bgColor, borderColor, icon;
                
                switch(card.type) {
                    case 'task':
                        icon = '‚úì';
                        if (card.priority === 1) {
                            bgColor = 'bg-red-50';
                            borderColor = 'border-red-300';
                        } else {
                            bgColor = 'bg-yellow-50';
                            borderColor = 'border-yellow-300';
                        }
                        break;
                    case 'exam':
                        icon = 'üö®';
                        bgColor = 'bg-red-50';
                        borderColor = 'border-red-300';
                        break;
                    case 'alert':
                        icon = '‚ö†Ô∏è';
                        bgColor = 'bg-orange-50';
                        borderColor = 'border-orange-300';
                        break;
                    case 'review':
                        icon = 'üìö';
                        bgColor = 'bg-purple-50';
                        borderColor = 'border-purple-300';
                        break;
                    case 'focus':
                        icon = 'üéØ';
                        bgColor = 'bg-green-50';
                        borderColor = 'border-green-300';
                        break;
                    case 'wellness':
                        icon = '‚ú®';
                        bgColor = 'bg-cyan-50';
                        borderColor = 'border-cyan-300';
                        break;
                    default:
                        icon = '‚Ä¢';
                        bgColor = 'bg-gray-50';
                        borderColor = 'border-gray-300';
                }
                
                cardEl.className = `${bgColor} border ${borderColor} rounded-xl p-6 hover:shadow-md transition`;
                
                let actionButton = '';
                if (card.type === 'task') {
                    actionButton = `<button onclick="markTaskComplete('${card.metadata.taskId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">Mark Complete</button>`;
                } else if (card.type === 'review') {
                    actionButton = `<button onclick="startStudyMode('${card.metadata.deckId}'); switchModule('flashcards');" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">Start Review</button>`;
                } else if (card.type === 'wellness') {
                    actionButton = `<button onclick="switchModule('productivity')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">Start Focus Block</button>`;
                } else if (card.type === 'focus' && card.metadata.needsSetup) {
                    actionButton = `<button onclick="showFocusSetup()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">Set Focus</button>`;
                } else if (card.type === 'exam' || card.type === 'alert') {
                    actionButton = `<button onclick="switchModule('grades')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">View Course</button>`;
                }
                
                let dateDisplay = '';
                if (card.dueDate) {
                    const dateObj = new Date(card.dueDate);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
                    dateDisplay = `<p class="text-sm text-gray-600 mt-2">üìÖ ${formattedDate}</p>`;
                }
                
                cardEl.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="text-3xl flex-shrink-0">${icon}</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-1">${escapeHtml(card.title)}</h3>
                            <p class="text-gray-700">${escapeHtml(card.description)}</p>
                            ${dateDisplay}
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        ${actionButton}
                    </div>
                `;
                
                container.appendChild(cardEl);
            });
        }

        function markTaskComplete(taskId) {
            if (!taskId) return;
            const task = appState.tasks.find(t => t.id === taskId);
            if (task) {
                task.column = 'done';
                saveState('task_completed');
                renderKanbanBoard();
                buildDailySyllabus();
            }
        }

        function showFocusSetup() {
            // Create inline focus setup in syllabus
            const container = document.getElementById('syllabusContent');
            const focusCard = document.createElement('div');
            focusCard.className = 'bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-4';
            focusCard.innerHTML = `
                <label class="block text-gray-700 font-semibold mb-3">What is your main focus today?</label>
                <input 
                    type="text" 
                    id="inlineFocusInput" 
                    placeholder="What is your main focus today?"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 text-lg mb-3"
                />
                <button onclick="saveInlineFocus()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition font-medium">
                    Set Focus
                </button>
            `;
            
            container.insertBefore(focusCard, container.firstChild);
            document.getElementById('inlineFocusInput').focus();
        }

        function saveInlineFocus() {
            const input = document.getElementById('inlineFocusInput');
            if (input) {
                const value = input.value.trim();
                if (!value) {
                    alert('Please enter your main focus');
                    return;
                }
                
                appState.dailyFocus = value;
                appState.focusIsSet = true;
                saveState('inline_focus_set');
                buildDailySyllabus();
            }
        }

        // ===== THEME TOGGLE =====
        function toggleTheme() {
            appState.theme = appState.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveState('theme_toggled');
        }

        function applyTheme() {
            const html = document.documentElement;
            const toggleBtn = document.getElementById('themeToggle');
            
            if (appState.theme === 'dark') {
                html.classList.add('dark');
                if (toggleBtn) toggleBtn.textContent = '‚òÄÔ∏è';
            } else {
                html.classList.remove('dark');
                if (toggleBtn) toggleBtn.textContent = 'üåô';
            }
        }

        // ===== POMODORO SETTINGS =====
        function initializePomodoro() {
            TIMER_MODES.work.duration = appState.pomodoroSettings.work * 60;
            TIMER_MODES.short.duration = appState.pomodoroSettings.shortBreak * 60;
            TIMER_MODES.long.duration = appState.pomodoroSettings.longBreak * 60;
            
            if (appState.pomodoro.mode === 'work') {
                appState.pomodoro.remainingSeconds = TIMER_MODES.work.duration;
            } else if (appState.pomodoro.mode === 'short') {
                appState.pomodoro.remainingSeconds = TIMER_MODES.short.duration;
            } else if (appState.pomodoro.mode === 'long') {
                appState.pomodoro.remainingSeconds = TIMER_MODES.long.duration;
            }
        }

        function openPomodoroSettings() {
            const workInput = document.getElementById('settingsWork');
            if (workInput) workInput.value = appState.pomodoroSettings.work;
            const shortInput = document.getElementById('settingsShortBreak');
            if (shortInput) shortInput.value = appState.pomodoroSettings.shortBreak;
            const longInput = document.getElementById('settingsLongBreak');
            if (longInput) longInput.value = appState.pomodoroSettings.longBreak;
            
            const modal = document.getElementById('pomodoroSettingsModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closePomodoroSettings() {
            const modal = document.getElementById('pomodoroSettingsModal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        function savePomodoroSettings() {
            const workInput = document.getElementById('settingsWork');
            const shortInput = document.getElementById('settingsShortBreak');
            const longInput = document.getElementById('settingsLongBreak');
            
            // Add null checks before accessing properties
            if (!workInput || !shortInput || !longInput) {
                console.error('Pomodoro settings inputs not found');
                return;
            }
            
            const workValid = validatePomodoroInput(workInput, 1, 120);
            const shortValid = validatePomodoroInput(shortInput, 1, 60);
            const longValid = validatePomodoroInput(longInput, 1, 60);
            
            if (!workValid || !shortValid || !longValid) {
                return;
            }
            
            const work = parseInt(workInput.value);
            const shortBreak = parseInt(shortInput.value);
            const longBreak = parseInt(longInput.value);
            
            appState.pomodoroSettings.work = work;
            appState.pomodoroSettings.shortBreak = shortBreak;
            appState.pomodoroSettings.longBreak = longBreak;
            
            initializePomodoro();
            updateTimerDisplay();
            saveState('pomodoro_settings_changed');
            closePomodoroSettings();
            
            // Show success feedback
            showToast('‚úÖ Settings Saved', 'Pomodoro timer settings updated successfully!');
        }

        // Override timerComplete to log study data
        function timerComplete() {
            pauseTimer();
            appState.pomodoro.remainingSeconds = 0;
            updateTimerDisplay();
            
            // Log work session to studyHistory
            if (appState.pomodoro.mode === 'work') {
                const today = getTodayDateString();
                const minutes = appState.pomodoroSettings.work;
                
                appState.studyHistory.push({
                    date: today,
                    minutes: minutes
                });
                
                saveState('pomodoro_completed');
                updateProfileStats();
                renderChart();
                renderAchievements();
                
                alert('‚è∞ Work Session Complete! ' + minutes + ' minutes logged to your study history!');
            } else {
                alert('‚è∞ Timer Complete! ' + TIMER_MODES[appState.pomodoro.mode].label + ' finished!');
            }
            
            resetTimer();
        }

        // ===== INPUT VALIDATION =====
        function validatePomodoroInput(input, min, max) {
            const value = parseInt(input.value);
            const errorEl = document.getElementById('error-' + input.id);
            
            if (isNaN(value) || value < min || value > max) {
                input.classList.add('input-error');
                errorEl.classList.add('show');
                return false;
            } else {
                input.classList.remove('input-error');
                errorEl.classList.remove('show');
                return true;
            }
        }
        
        function validateDailyGoalInput(input) {
            const value = parseInt(input.value);
            const errorEl = document.getElementById('error-' + input.id);
            
            if (isNaN(value) || value < 1 || value > 1440) {
                input.classList.add('input-error');
                errorEl.classList.add('show');
                return false;
            } else {
                input.classList.remove('input-error');
                errorEl.classList.remove('show');
                return true;
            }
        }
        
        function validateGradeInput(input, min, max, fieldName) {
            const value = parseFloat(input.value);
            const errorId = 'error-' + input.id;
            let errorEl = document.getElementById(errorId);
            
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.id = errorId;
                errorEl.className = 'error-message';
                errorEl.textContent = fieldName + ' must be between ' + min + ' and ' + max;
                input.parentNode.appendChild(errorEl);
            }
            
            if (isNaN(value) || value < min || value > max) {
                input.classList.add('input-error');
                errorEl.classList.add('show');
                return false;
            } else {
                input.classList.remove('input-error');
                errorEl.classList.remove('show');
                return true;
            }
        }
        
        // ===== TOAST NOTIFICATIONS =====
        function showToast(title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            toast.innerHTML = `
                <div class="toast-icon">üéâ</div>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-message">${escapeHtml(message)}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Remove on click
            toast.addEventListener('click', () => {
                removeToast(toast);
            });
            
            // Auto-remove after 4.5 seconds
            setTimeout(() => {
                removeToast(toast);
            }, 4500);
            
            // Limit to 3 toasts
            const toasts = container.querySelectorAll('.toast');
            if (toasts.length > 3) {
                removeToast(toasts[0]);
            }
        }
        
        function removeToast(toast) {
            if (!toast || !toast.parentNode) return;
            
            toast.classList.add('fade-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }
        
        // ===== MUSIC PLAYER WITH INDEXEDDB =====
        let musicPlaylist = [];
        let currentTrackIndex = -1;
        let isPlaying = false;
        
        async function handleMusicUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // TODO: Add a loading spinner here
            
            let uploadSuccess = false;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('audio/')) {
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    try {
                        const response = await fetch('/api/upload-music', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Upload failed');
                        }
                        
                        const result = await response.json();
                        // result = { name: "song.mp3", url: "/music/song.mp3" }
                        
                        // Add to our runtime playlist
                        musicPlaylist.push({
                            id: generateId(),
                            name: result.name,
                            url: result.url
                        });
                        uploadSuccess = true;
                        
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        alert(`Failed to upload ${file.name}`);
                    }
                }
            }
            
            // TODO: Hide loading spinner here
            
            if (uploadSuccess) {
                document.getElementById('musicEmptyState').classList.add('hidden');
                document.getElementById('musicPlayerSection').classList.remove('hidden');
                renderPlaylist();
                
                // Auto-play first track if nothing is playing
                if (currentTrackIndex === -1 && musicPlaylist.length > 0) {
                    playTrack(0);
                }
                
                // Save the new playlist state
                appState.musicPlaylist = musicPlaylist;
                autoSave('music_uploaded');
            }
            
            // Reset file input
            event.target.value = '';
        }
        
        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            if (!container) return;
            container.innerHTML = '';
            
            if (musicPlaylist.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No tracks in playlist</p>';
                return;
            }
            
            musicPlaylist.forEach((track, index) => {
                const trackEl = document.createElement('div');
                const isActive = index === currentTrackIndex;
                trackEl.className = 'flex items-center justify-between p-3 rounded-lg cursor-pointer transition';
                trackEl.style.backgroundColor = isActive ? 'var(--bg-tertiary)' : 'var(--bg-secondary)';
                trackEl.style.borderLeft = isActive ? '4px solid var(--accent-primary)' : 'none';
                
                trackEl.innerHTML = `
                    <div class="flex items-center gap-3 flex-1" onclick="playTrack(${index})">
                        <span style="color: var(--text-primary);">${isActive ? '‚ñ∂Ô∏è' : 'üéµ'}</span>
                        <span style="color: var(--text-primary); font-medium: ${isActive ? '600' : '400'};">${escapeHtml(track.name)}</span>
                    </div>
                    <button onclick="removeTrack(${index})" class="px-2 py-1 rounded transition" style="color: var(--danger);">√ó</button>
                `;
                
                container.appendChild(trackEl);
            });
        }
        
        function playTrack(index) {
            if (index < 0 || index >= musicPlaylist.length) return;
            
            const audio = document.getElementById('musicAudioPlayer');
            if (!audio) return;
            
            const track = musicPlaylist[index];
            if (!track) return;
            
            audio.src = track.url;
            audio.load();
            audio.play();
            
            currentTrackIndex = index;
            isPlaying = true;
            
            const trackNameEl = document.getElementById('currentTrackName');
            if (trackNameEl) trackNameEl.textContent = track.name;
            const playPauseBtnEl = document.getElementById('playPauseBtn');
            if (playPauseBtnEl) playPauseBtnEl.textContent = '‚è∏Ô∏è Pause';
            
            renderPlaylist();
            
            // Setup audio event listeners
            audio.ontimeupdate = updateProgress;
            audio.onended = () => {
                nextTrack();
            };
            audio.onloadedmetadata = () => {
                const durationEl = document.getElementById('totalDuration');
                if (durationEl) durationEl.textContent = formatTime(audio.duration);
            };
        }
        
        function togglePlayPause() {
            const audio = document.getElementById('musicAudioPlayer');
            if (!audio) return;
            
            if (musicPlaylist.length === 0) {
                alert('Please upload music files first');
                return;
            }
            
            if (currentTrackIndex === -1) {
                playTrack(0);
                return;
            }
            
            if (isPlaying) {
                audio.pause();
                isPlaying = false;
                const btn = document.getElementById('playPauseBtn');
                if (btn) btn.textContent = '‚ñ∂Ô∏è Play';
            } else {
                audio.play();
                isPlaying = true;
                const btn = document.getElementById('playPauseBtn');
                if (btn) btn.textContent = '‚è∏Ô∏è Pause';
            }
        }
        
        function nextTrack() {
            if (musicPlaylist.length === 0) return;
            
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= musicPlaylist.length) {
                nextIndex = 0;
            }
            
            playTrack(nextIndex);
        }
        
        function previousTrack() {
            if (musicPlaylist.length === 0) return;
            
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) {
                prevIndex = musicPlaylist.length - 1;
            }
            
            playTrack(prevIndex);
        }
        
        function seekTrack(value) {
            const audio = document.getElementById('musicAudioPlayer');
            if (!audio) return;
            if (audio.duration) {
                audio.currentTime = (value / 100) * audio.duration;
            }
        }
        
        function updateVolume(value) {
            const audio = document.getElementById('musicAudioPlayer');
            if (!audio) return;
            audio.volume = value / 100;
            const label = document.getElementById('volumeLabel');
            if (label) label.textContent = value + '%';
        }
        
        function updateProgress() {
            const audio = document.getElementById('musicAudioPlayer');
            if (!audio || !audio.duration) return;
            
            const progress = (audio.currentTime / audio.duration) * 100;
            const seekBar = document.getElementById('seekBar');
            if (seekBar) seekBar.value = progress;
            const currentTime = document.getElementById('currentTime');
            if (currentTime) currentTime.textContent = formatTime(audio.currentTime);
        }
        
        async function removeTrack(index) {
            if (!confirm('Remove this track from the playlist and delete the file?')) return;
            
            try {
                const track = musicPlaylist[index];
                if (!track) return;

                // 1. Tell backend to delete the file
                const response = await fetch('/api/delete-music', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: track.name })
                });

                if (!response.ok) {
                    // If file not found on server, we still remove it from playlist
                    if (response.status !== 404) {
                         throw new Error('Server failed to delete file.');
                    }
                    console.warn(`File not found on server, but removing from playlist: ${track.name}`);
                }

                // 2. Revoke object URL (just in case, though it's now a server URL)
                // URL.revokeObjectURL(track.url); // Not needed for server URLs
                
                // 3. If removing current track, stop playback
                if (index === currentTrackIndex) {
                    const audio = document.getElementById('musicAudioPlayer');
                    audio.pause();
                    audio.src = '';
                    isPlaying = false;
                    currentTrackIndex = -1;
                    const trackName = document.getElementById('currentTrackName');
                    if (trackName) trackName.textContent = 'No track playing';
                    const playPauseBtn = document.getElementById('playPauseBtn');
                    if (playPauseBtn) playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                } else if (index < currentTrackIndex) {
                    currentTrackIndex--;
                }
                
                // 4. Remove from runtime playlist
                musicPlaylist.splice(index, 1);
                
                // 5. Update UI
                if (musicPlaylist.length === 0) {
                    document.getElementById('musicEmptyState')?.classList.remove('hidden');
                    document.getElementById('musicPlayerSection')?.classList.add('hidden');
                } else {
                    renderPlaylist();
                }

                // 6. Save the new state
                appState.musicPlaylist = musicPlaylist;
                autoSave('music_removed');
                
                showToast('üóëÔ∏è Track Removed', 'The track has been deleted.');
                
            } catch (error) {
                console.error('Error deleting track:', error);
                alert('Failed to delete track. Please try again.');
            }
        }
        
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        // ===== AMBIENT SOUNDS (REMOVED) =====
        // Ambient sounds removed - replaced with Music Player
        
        const AMBIENT_SOUNDS_OLD = [
            { id: 'rain', name: 'Rain', icon: 'üåßÔ∏è', type: 'pink_noise' },
            { id: 'coffee', name: 'Coffee Shop', icon: '‚òï', type: 'brown_noise' },
            { id: 'forest', name: 'Forest', icon: 'üå≤', type: 'nature' },
            { id: 'white_noise', name: 'White Noise', icon: 'üìª', type: 'white_noise' },
            { id: 'ocean', name: 'Ocean Waves', icon: 'üåä', type: 'ocean' },
            { id: 'study', name: 'Study Music', icon: 'üéµ', type: 'tone' }
        ];

        function renderAmbientSoundsOLD() {
            const container = document.getElementById('ambientSoundsGrid');
            container.innerHTML = '';
            
            AMBIENT_SOUNDS.forEach(sound => {
                const soundCard = document.createElement('div');
                const isPlaying = appState.ambientSound.playing && appState.ambientSound.current === sound.id;
                
                soundCard.className = `bg-white dark:bg-slate-700 rounded-xl shadow-sm border ${
                    isPlaying ? 'border-blue-500 dark:border-blue-400' : 'border-gray-200 dark:border-gray-600'
                } p-5 transition`;
                
                soundCard.innerHTML = `
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">${sound.icon}</div>
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100">${sound.name}</h4>
                    </div>
                    <button 
                        onclick="toggleAmbientSound('${sound.id}')" 
                        class="w-full ${isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'} text-white px-4 py-2 rounded-lg transition font-medium mb-3"
                    >
                        ${isPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Play'}
                    </button>
                `;
                
                container.appendChild(soundCard);
            });
        }

        function updateGlobalVolumeOLD(value) {
            appState.ambientSound.volume = parseInt(value);
            document.getElementById('globalVolumeLabel').textContent = value + '%';
            
            if (appState.currentAudioNode && appState.currentAudioNode.gain) {
                appState.currentAudioNode.gain.value = value / 100;
            }
            
            saveToLocalStorage();
        }

        function toggleAmbientSoundOLD(soundId) {
            if (appState.ambientSound.playing && appState.ambientSound.current === soundId) {
                stopAmbientSound();
            } else {
                playAmbientSound(soundId);
            }
        }

        function playAmbientSoundOLD(soundId) {
            stopAmbientSound();
            
            if (!appState.audioContext) {
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const sound = AMBIENT_SOUNDS.find(s => s.id === soundId);
            if (!sound) return;
            
            const ctx = appState.audioContext;
            const gainNode = ctx.createGain();
            gainNode.gain.value = appState.ambientSound.volume / 100;
            gainNode.connect(ctx.destination);
            
            let oscillator, noiseBuffer, noiseSource;
            
            switch(sound.type) {
                case 'pink_noise':
                case 'brown_noise':
                case 'white_noise':
                    noiseBuffer = createNoiseBuffer(ctx, sound.type);
                    noiseSource = ctx.createBufferSource();
                    noiseSource.buffer = noiseBuffer;
                    noiseSource.loop = true;
                    noiseSource.connect(gainNode);
                    noiseSource.start();
                    appState.currentAudioNode = { source: noiseSource, gain: gainNode.gain };
                    break;
                    
                case 'nature':
                    noiseBuffer = createNoiseBuffer(ctx, 'pink_noise');
                    noiseSource = ctx.createBufferSource();
                    noiseSource.buffer = noiseBuffer;
                    noiseSource.loop = true;
                    const filter = ctx.createBiquadFilter();
                    filter.type = 'bandpass';
                    filter.frequency.value = 1000;
                    noiseSource.connect(filter);
                    filter.connect(gainNode);
                    noiseSource.start();
                    appState.currentAudioNode = { source: noiseSource, gain: gainNode.gain };
                    break;
                    
                case 'ocean':
                    oscillator = ctx.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 0.5;
                    const lfoGain = ctx.createGain();
                    lfoGain.gain.value = 100;
                    oscillator.connect(lfoGain);
                    
                    noiseBuffer = createNoiseBuffer(ctx, 'brown_noise');
                    noiseSource = ctx.createBufferSource();
                    noiseSource.buffer = noiseBuffer;
                    noiseSource.loop = true;
                    const oceanOsc = ctx.createOscillator();
                    oceanOsc.type = 'sine';
                    oceanOsc.frequency.value = 80;
                    lfoGain.connect(oceanOsc.frequency);
                    
                    noiseSource.connect(gainNode);
                    oceanOsc.connect(gainNode);
                    
                    oscillator.start();
                    oceanOsc.start();
                    noiseSource.start();
                    
                    appState.currentAudioNode = { 
                        source: noiseSource, 
                        oscillator: oceanOsc, 
                        lfo: oscillator,
                        gain: gainNode.gain 
                    };
                    break;
                    
                case 'tone':
                    oscillator = ctx.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 432;
                    const oscillator2 = ctx.createOscillator();
                    oscillator2.type = 'sine';
                    oscillator2.frequency.value = 528;
                    
                    oscillator.connect(gainNode);
                    oscillator2.connect(gainNode);
                    oscillator.start();
                    oscillator2.start();
                    
                    appState.currentAudioNode = { 
                        oscillator: oscillator,
                        oscillator2: oscillator2,
                        gain: gainNode.gain 
                    };
                    break;
            }
            
            appState.ambientSound.current = soundId;
            appState.ambientSound.playing = true;
            saveToLocalStorage();
            renderAmbientSounds();
        }

        function stopAmbientSoundOLD() {
            if (appState.currentAudioNode) {
                try {
                    if (appState.currentAudioNode.source) appState.currentAudioNode.source.stop();
                    if (appState.currentAudioNode.oscillator) appState.currentAudioNode.oscillator.stop();
                    if (appState.currentAudioNode.oscillator2) appState.currentAudioNode.oscillator2.stop();
                    if (appState.currentAudioNode.lfo) appState.currentAudioNode.lfo.stop();
                } catch (e) {
                    console.log('Audio node already stopped');
                }
                appState.currentAudioNode = null;
            }
            
            appState.ambientSound.playing = false;
            appState.ambientSound.current = null;
            saveToLocalStorage();
            renderAmbientSounds();
        }

        function createNoiseBuffer(ctx, type) {
            const bufferSize = ctx.sampleRate * 2;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const output = buffer.getChannelData(0);
            
            if (type === 'white_noise') {
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
            } else if (type === 'pink_noise') {
                let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    output[i] *= 0.11;
                    b6 = white * 0.115926;
                }
            } else if (type === 'brown_noise') {
                let lastOut = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5;
                }
            }
            
            return buffer;
        }

        // ===== PROFILE & ANALYTICS =====
        function saveDailyGoal() {
            const input = document.getElementById('dailyGoalInput');
            if (!validateDailyGoalInput(input)) {
                return;
            }
            const goal = parseInt(input.value);
            
            appState.dailyStudyGoal = goal;
            saveState('study_goal_changed');
            updateProfileStats();
            renderAchievements();
            alert('Daily study goal saved!');
        }

        function calculateStreak() {
            if (appState.studyHistory.length === 0) return 0;
            
            const dailyTotals = {};
            appState.studyHistory.forEach(entry => {
                if (!dailyTotals[entry.date]) {
                    dailyTotals[entry.date] = 0;
                }
                dailyTotals[entry.date] += entry.minutes;
            });
            
            let streak = 0;
            const today = getTodayDateString();
            let currentDate = new Date(today);
            
            while (true) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const total = dailyTotals[dateStr] || 0;
                
                if (total >= appState.dailyStudyGoal) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
                
                if (streak > 1000) break;
            }
            
            return streak;
        }
        
        // Track unlocked achievements in memory
        let unlockedAchievements = [];
        
        function getUnlockedAchievements() {
            return unlockedAchievements;
        }
        
        function saveUnlockedAchievements(achievements) {
            unlockedAchievements = achievements;
        }
        
        function checkNewAchievements(streak) {
            const unlocked = getUnlockedAchievements();
            const newAchievements = [];
            
            ACHIEVEMENTS.forEach(achievement => {
                if (streak >= achievement.requirement && !unlocked.includes(achievement.id)) {
                    newAchievements.push(achievement);
                    unlocked.push(achievement.id);
                }
            });
            
            if (newAchievements.length > 0) {
                saveUnlockedAchievements(unlocked);
                saveState();
                
                // Show toast for each new achievement
                newAchievements.forEach((achievement, index) => {
                    setTimeout(() => {
                        showToast('üéâ Achievement Unlocked: ' + achievement.name, achievement.icon + ' ' + achievement.requirement + ' day streak!');
                    }, index * 500);
                });
            }
        }

        function updateProfileStats() {
            try {
                const streak = calculateStreak();
                
                // Check for new achievements
                checkNewAchievements(streak);
                
                const streakCount = document.getElementById('streakCount');
                if (streakCount) streakCount.textContent = `${streak}-Day Streak`;
            
                const streakMessage = document.getElementById('streakMessage');
                if (streakMessage) {
                    if (streak === 0) {
                        streakMessage.textContent = 'Start studying to build your streak!';
                    } else if (streak === 1) {
                        streakMessage.textContent = 'Great start! Keep it going!';
                    } else if (streak < 7) {
                        streakMessage.textContent = `You're on fire! ${7 - streak} more days to one week!`;
                    } else {
                        streakMessage.textContent = 'Amazing consistency! Keep up the great work!';
                    }
                }
            
                const totalMinutes = appState.studyHistory.reduce((sum, entry) => sum + entry.minutes, 0);
                const totalStudyTime = document.getElementById('totalStudyTime');
                if (totalStudyTime) totalStudyTime.textContent = totalMinutes;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentHistory = appState.studyHistory.filter(entry => {
                return new Date(entry.date) >= thirtyDaysAgo;
            });
                const avgDaily = recentHistory.length > 0 ? 
                    Math.round(recentHistory.reduce((sum, entry) => sum + entry.minutes, 0) / 30) : 0;
                const avgDailyTime = document.getElementById('avgDailyTime');
                if (avgDailyTime) avgDailyTime.textContent = avgDaily;
            
                const totalSessions = document.getElementById('totalSessions');
                if (totalSessions) totalSessions.textContent = appState.studyHistory.length;
                
                const uniqueDates = new Set(appState.studyHistory.map(entry => entry.date));
                const productiveDays = document.getElementById('productiveDays');
                if (productiveDays) productiveDays.textContent = uniqueDates.size;
            } catch (error) {
                console.error('Error updating profile stats:', error);
            }
        }

        const ACHIEVEMENTS = [
            { id: 'day1', name: 'Getting Started', icon: 'üå±', requirement: 1 },
            { id: 'day3', name: 'On a Roll', icon: 'üéØ', requirement: 3 },
            { id: 'week1', name: 'One Week Warrior', icon: 'üí™', requirement: 7 },
            { id: 'week2', name: 'Two Week Champion', icon: 'üèÜ', requirement: 14 },
            { id: 'month1', name: 'Monthly Master', icon: 'üëë', requirement: 30 },
            { id: 'month2', name: 'Consistency King', icon: 'üíé', requirement: 60 },
            { id: 'century', name: 'Century Club', icon: 'üåü', requirement: 100 }
        ];

        function renderAchievements() {
            const container = document.getElementById('achievementsGrid');
            if (!container) return;
            
            const streak = calculateStreak();
            
            container.innerHTML = '';
            
            ACHIEVEMENTS.forEach(achievement => {
                const unlocked = streak >= achievement.requirement;
                const achievementEl = document.createElement('div');
                achievementEl.className = 'text-center p-4 rounded-lg';
                achievementEl.style.backgroundColor = unlocked ? 'rgba(250, 204, 21, 0.2)' : 'var(--bg-secondary)';
                achievementEl.style.border = unlocked ? '2px solid #fbbf24' : '1px solid var(--border-color)';
                achievementEl.style.opacity = unlocked ? '1' : '0.5';
                achievementEl.title = achievement.name + (unlocked ? ' - Unlocked!' : ` - Requires ${achievement.requirement} day streak`);
                
                achievementEl.innerHTML = `
                    <div class="text-3xl mb-2">${achievement.icon}</div>
                    <div class="text-xs font-semibold" style="color: var(--text-primary);">${achievement.name}</div>
                    <div class="text-xs mt-1" style="color: var(--text-secondary);">${achievement.requirement} days</div>
                `;
                
                container.appendChild(achievementEl);
            });
        }
        
        function updateMotivator() {
            try {
                const streak = calculateStreak();
                const unlocked = getUnlockedAchievements();
                
                // Update icon and title based on streak
                const iconEl = document.getElementById('motivatorIcon');
                const titleEl = document.getElementById('motivatorTitle');
                const messageEl = document.getElementById('motivatorMessage');
                const achievementEl = document.getElementById('motivatorAchievement');
                const achievementTextEl = document.getElementById('latestAchievementText');
                
                if (!iconEl || !titleEl || !messageEl) return;
            
            if (streak === 0) {
                iconEl.textContent = 'üå±';
                titleEl.textContent = 'Start Your Journey';
                messageEl.textContent = 'Every expert was once a beginner. Start your first Pomodoro session!';
                achievementEl.style.display = 'none';
            } else if (streak === 1) {
                iconEl.textContent = 'üéâ';
                titleEl.textContent = 'Great Start!';
                messageEl.textContent = 'One day down! Keep the momentum going!';
            } else if (streak < 7) {
                iconEl.textContent = 'üî•';
                titleEl.textContent = `${streak}-Day Streak!`;
                messageEl.textContent = `You're on fire! ${7 - streak} more days to one week!`;
            } else if (streak < 30) {
                iconEl.textContent = 'üî•';
                titleEl.textContent = `${streak}-Day Streak!`;
                messageEl.textContent = 'Amazing consistency! Keep up the great work!';
            } else {
                iconEl.textContent = 'üëë';
                titleEl.textContent = `${streak}-Day Streak!`;
                messageEl.textContent = 'Unstoppable! You are a productivity champion!';
            }
            
                // Show latest achievement
                if (achievementEl && achievementTextEl && unlocked.length > 0) {
                const latestId = unlocked[unlocked.length - 1];
                const latestAchievement = ACHIEVEMENTS.find(a => a.id === latestId);
                if (latestAchievement) {
                    achievementEl.style.display = 'block';
                        achievementTextEl.textContent = latestAchievement.icon + ' ' + latestAchievement.name;
                    }
                } else if (achievementEl) {
                    achievementEl.style.display = 'none';
                }
            
                // Check if goal met today
                const today = getTodayDateString();
            const todayMinutes = appState.studyHistory
                .filter(entry => entry.date === today)
                .reduce((sum, entry) => sum + entry.minutes, 0);
            
            if (todayMinutes >= appState.dailyStudyGoal) {
                messageEl.textContent = 'Fantastic work today! üéâ Goal crushed! üí™';
            } else if (todayMinutes > 0) {
                    const remaining = appState.dailyStudyGoal - todayMinutes;
                    messageEl.textContent = `Great progress! ${remaining} more minutes to reach your goal today.`;
                }
            } catch (error) {
                console.error('Error updating motivator:', error);
            }
        }

        function setChartView(view) {
            appState.chartView = view;
            saveState('chart_view_changed');
            
            ['daily', 'weekly', 'monthly'].forEach(v => {
                const btn = document.getElementById('chartBtn-' + v);
                if (!btn) return;
                if (v === view) {
                    btn.className = 'px-4 py-2 rounded-lg font-medium transition';
                    btn.style.backgroundColor = 'var(--button-bg)';
                    btn.style.color = 'white';
                } else {
                    btn.className = 'px-4 py-2 rounded-lg font-medium transition';
                    btn.style.backgroundColor = 'var(--bg-tertiary)';
                    btn.style.color = 'var(--text-primary)';
                }
            });
            
            renderChart();
        }

        function renderChart() {
            const container = document.getElementById('chartContainer');
            if (!container) return;
            
            if (appState.studyHistory.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <div class="text-center">
                            <div class="text-5xl mb-4">üìä</div>
                            <p class="text-xl" style="color: var(--text-secondary);">Start studying to see your progress!</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let chartData = [];
            
            if (appState.chartView === 'daily') {
                const days = 7;
                const today = new Date();
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    // ===== FIX IS HERE =====
                    // We now use the same local-date logic as getTodayDateString()
                    // instead of the UTC-based toISOString().
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`; 
                    // ===== END FIX =====
                    
                    const dayTotal = appState.studyHistory
                        .filter(entry => entry.date === dateStr)
                        .reduce((sum, entry) => sum + entry.minutes, 0);
                    
                    chartData.push({
                        label: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        value: dayTotal
                    });
                }
            } else if (appState.chartView === 'weekly') {
                const weeks = 6;
                const today = new Date();
                
                for (let i = weeks - 1; i >= 0; i--) {
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() - (i * 7));
                    weekEnd.setHours(23, 59, 59, 999); // End of the day
                    const weekStart = new Date(weekEnd);
                    weekStart.setDate(weekStart.getDate() - 6);
                    weekStart.setHours(0, 0, 0, 0); // Start of the day
                    
                    const weekTotal = appState.studyHistory
                        .filter(entry => {
                            const entryDate = new Date(entry.date);
                            return entryDate >= weekStart && entryDate <= weekEnd;
                        })
                        .reduce((sum, entry) => sum + entry.minutes, 0);
                    
                    chartData.push({
                        // Label with start of week
                        label: weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                        value: weekTotal
                    });
                }
            } else if (appState.chartView === 'monthly') {
                const months = 6;
                const today = new Date();
                
                for (let i = months - 1; i >= 0; i--) {
                    const month = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthEnd = new Date(month.getFullYear(), month.getMonth() + 1, 0);
                    
                    const monthTotal = appState.studyHistory
                        .filter(entry => {
                            const entryDate = new Date(entry.date);
                            return entryDate >= month && entryDate <= monthEnd;
                        })
                        .reduce((sum, entry) => sum + entry.minutes, 0);
                    
                    chartData.push({
                        label: month.toLocaleDateString('en-US', { month: 'short' }),
                        value: monthTotal
                    });
                }
            }
            
            const maxValue = Math.max(...chartData.map(d => d.value), appState.dailyStudyGoal, 10); // Ensure a minimum height
            const scale = 300 / maxValue; // 300px is the target height
            
            let chartHTML = '<div class="flex items-end justify-around h-80 border-b-2 px-4" style="border-color: var(--border-color);">';
            
            chartData.forEach(data => {
                const height = data.value * scale;
                const meetsGoal = data.value >= appState.dailyStudyGoal;
                const barColor = meetsGoal ? 'var(--success)' : 'var(--accent-primary)';
                
                chartHTML += `
                    <div class="flex flex-col items-center flex-1 mx-1">
                        <div class="text-sm font-semibold mb-2" style="color: var(--text-primary);">${data.value}</div>
                        <div 
                            class="w-full rounded-t transition-all hover:opacity-80" 
                            style="height: ${Math.max(height, 5)}px; background-color: ${barColor};"
                            title="${data.label}: ${data.value} minutes"
                        ></div>
                        <div class="text-xs mt-2 text-center" style="color: var(--text-secondary);">${data.label}</div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            
            chartHTML += `
                <div class="mt-4 flex items-center justify-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded" style="background-color: var(--success);"></div>
                        <span style="color: var(--text-secondary);">Meets Goal (‚â•${appState.dailyStudyGoal} min)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded" style="background-color: var(--accent-primary);"></div>
                        <span style="color: var(--text-secondary);">Below Goal</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = chartHTML;
        }
    </script>
</body>
</html>